

<div class="tutorial-content">

<h2 id="introduction-lab1">Introduction</h2>

<p>In this tutorial, we will build a NiFi DataFlow to fetch vehicle location, speed, and other sensor data from a San Francisco Muni traffic simulator, look for observations of a specific few vehicles, and store the selected observations into a new file. Even though this aspect of the lab is not streaming data, you will see the importance of file I/O in NiFi dataflow application development and how it can be used to simulate streaming data.</p>

<p>In this lab, you will build the following dataflow:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/completed-data-flow-lab1.png" alt="completed-data-flow-lab1" /></p>

<p><strong>Figure 1:</strong> The completed dataflow contains three sections: ingest data from vehicle location XML Simulator, extract vehicle location detail attributes from FlowFiles and route these detail attributes to a JSON file as long as they are not empty strings. You will learn more in depth about each processors particular responsibility in each section of the dataflow.</p>

<p>Feel free to download the <a href="https://github.com/hortonworks/tutorials/blob/hdp/assets/learning-ropes-nifi-lab-series/trafficLocs_data_for_simulator.zip?raw=true">NiFi-DataFlow-Lab1.xml</a> template file or if you prefer to build the dataflow from scratch, continue on to <strong>Step 1</strong>.</p>

<p>1. Click on the template icon <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/nifi_template_icon.png" alt="nifi_template_icon" /> located in the upper right corner of the NiFi HTML interface.</p>

<p>2. Click <strong>Browse</strong>, find the template file, click <strong>Open</strong> and hit <strong>Import</strong>.</p>

<p>3. Hover over to the top left of the NiFi HTML interface, drag the template icon <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/nifi_template_icon.png" alt="nifi_template_icon" /> onto the graph and select the <strong>NiFi-DataFlow-Lab1.xml</strong> template file.</p>

<p>4. Hit the <strong>start</strong> button <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/start_button_nifi_iot.png" alt="start_button_nifi_iot" />. to activate the dataflow. We highly recommend you read through the lab, so you become familiar with the process of building a dataflow.</p>

<h2 id="pre-requisites-lab1">Pre-Requisites</h2>
<ul>
  <li>Completed Learning the Ropes of Apache NiFi</li>
  <li>Completed Lab 0: Download, Install and Start NiFi</li>
</ul>

<h2 id="outline-lab1">Outline</h2>
<ul>
  <li>Step 1: Explore NiFi HTML Interface</li>
  <li>Step 2: Create a NiFi DataFlow</li>
  <li>Step 3: Build XML Simulator DataFlow Section</li>
  <li>Step 4: Build Key Attribute Extraction DataFlow Section</li>
  <li>Step 5: Build Filter and JSON Conversion DataFlow Section</li>
  <li>Step 6: Run the NiFi DataFlow</li>
  <li>Summary</li>
  <li>Further Reading</li>
</ul>

<h3 id="step-1-explore-nifi-html-interface-lab1">Step 1: Explore NiFi HTML Interface</h3>

<p>Let's take a brief tour of NiFi's HTML interface and explore some of its features that enable users to build data flows.</p>

<p>NiFi's HTML interface contains 5 main sections: The <strong>Components</strong> toolbar, the <strong>Actions</strong> toolbar, the <strong>Management</strong> toolbar, the <strong>Search</strong> bar and the help button. The canvas is the area in which the data flow is built. View the image below for a visualization of these key areas.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/nifi_dataflow_html_interface.png" alt="nifi_dataflow_html_interface" /></p>

<p><strong>Figure 2:</strong> NiFi HTML interface contains four toolbars to build a dataflow or multiple dataflows.</p>

<h3 id="step-2-create-a-nifi-dataflow-lab1">Step 2: Create a NiFi DataFlow</h3>

<p>The building blocks of every dataflow consist of processors. These tools perform actions on data to ingest, route, extract, split, aggregate or store it. Our dataflow will contain these processors, each processor includes a high level description of their role in the lab:</p>

<ul>
  <li><strong>GetFile</strong> reads vehicle location data from traffic stream zip file</li>
  <li><strong>UnpackContent</strong> decompresses the zip file</li>
  <li><strong>ControlRate</strong> controls the rate at which FlowFiles move to the flow</li>
  <li><strong>EvaluateXPath(x2)</strong> extracts nodes (elements, attributes, etc.) from the XML file</li>
  <li><strong>SplitXml</strong> splits the XML file into separate FlowFiles, each comprised of children of the parent element</li>
  <li><strong>UpdateAttribute</strong> assigns each FlowFile a unique name</li>
  <li><strong>RouteOnAttribute</strong> makes the filtering decisions on the vehicle location data</li>
  <li><strong>AttributesToJSON</strong> represents the filtered attributes in JSON format</li>
  <li><strong>MergeContent</strong> merges the FlowFiles into one FlowFile by concatenating their JSON content together</li>
  <li><strong>PutFile</strong> writes filtered vehicle location data content to a directory on the local file system</li>
</ul>

<p>Refer to <a href="https://nifi.apache.org/docs.html">NiFi's Documentation</a> to learn more about each processor described above.</p>

<h3 id="learning-objectives-overview-of-dataflow-build-process-lab1">2.1 Learning Objectives: Overview of DataFlow Build Process</h3>
<ul>
  <li>Build a NiFi DataFlow to ingest, filter, convert and store moving data</li>
  <li>Establish relationships or connections for each processors</li>
  <li>Troubleshoot problems that may occur</li>
  <li>Run the the NiFi DataFlow</li>
</ul>

<p>Your dataflow will extract the following XML Attributes from the transit data listed in Table 1. We will learn how to do this extraction with evaluateXPath when we build our dataflow.</p>

<p><strong>Table 1: Extracted XML Attributes From Transit Data</strong></p>

<table>
  <thead>
    <tr>
      <th>Attribute Name</th>
      <th>Type</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>id</td>
      <td>string</td>
      <td>Vehicle ID</td>
    </tr>
    <tr>
      <td>time</td>
      <td>int64</td>
      <td>Observation timestamp</td>
    </tr>
    <tr>
      <td>lat</td>
      <td>float64</td>
      <td>Latitude (degrees)</td>
    </tr>
    <tr>
      <td>lon</td>
      <td>float64</td>
      <td>Longitude (degrees)</td>
    </tr>
    <tr>
      <td>speedKmHr</td>
      <td>float64</td>
      <td>Vehicle speed (km/h)</td>
    </tr>
    <tr>
      <td>dirTag</td>
      <td>float64</td>
      <td>Direction of travel</td>
    </tr>
  </tbody>
</table>

<p>After extracting, filtering and converting the data, your new file, which contains transit location data will be stored in the Input Directory listed in Table 2. We will learn how to satisfy the conditions in Table 2 with RouteOnAttribute, AttributesToJSON and PutFile processors.</p>

<p><strong>Table 2: Other DataFlow Requirements</strong></p>

<table>
  <thead>
    <tr>
      <th>Parameter</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Input Directory</td>
      <td>/home/nifi/input</td>
    </tr>
    <tr>
      <td>Output Directory</td>
      <td>/home/nifi/output/filtered_transitLoc_data</td>
    </tr>
    <tr>
      <td>File Format</td>
      <td>JSON</td>
    </tr>
    <tr>
      <td>Filter For</td>
      <td>id, time, lat, lon, speedKmHr, dirTag</td>
    </tr>
  </tbody>
</table>

<p>Let's build our dataflow to fetch, filter, convert and store transit sensor data from San Francisco Muni, M-Ocean View route. Here is a visualization, courtesy of NextBus and Google, of the data NiFi generates using our Traffic XML Simulator:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/live_stream_sf_muni_nifi_learning_ropes.png" alt="sf_ocean_view_route_nifi_streaming" /></p>

<h3 id="add-processors-lab1">2.2 Add processors</h3>

<p>1. Go to the <strong>components</strong> toolbar, drag and drop the processor icon <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/processor_nifi_iot.png" alt="processor_nifi_iot" /> onto the graph.</p>

<p>An <strong>Add Processor</strong> window will appear with 3 ways to find our desired processor: <strong>processor list</strong>, <strong>tag cloud</strong>, or <strong>filter bar</strong></p>

<ul>
  <li>processor list: contains almost 160 processors</li>
  <li>tag cloud: reduces list by category</li>
  <li>filter bar: search for desired processor</li>
</ul>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/add_processor_window.png" alt="add_processor_window" /></p>

<p>2. Select the <strong>GetFile</strong> processor and a short description of the processor's function will appear.</p>

<ul>
  <li><strong>GetFile</strong> fetches the vehicle location simulator data for files in a directory.</li>
</ul>

<p>Click the <strong>Add</strong> button to add the processor to the graph.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/add_processor_getfile_nifi-learn-ropes.png" alt="add_processor_getfile_nifi-learn-ropes" /></p>

<p>3. Add the <strong>UnpackContent, ControlRate, EvaluateXPath, SplitXML, UpdateAttribute, EvaluateXPath, RouteOnAttribute, AttributesToJSON, MergeContent</strong> and <strong>PutFile</strong> processors using the processor icon.</p>

<p>Overview of Each Processor's Role in our DataFlow:</p>

<ul>
  <li>
    <p><strong>UnpackContent</strong> decompresses the contents of FlowFiles from the traffic simulator zip file.</p>
  </li>
  <li>
    <p><strong>ControlRate</strong> controls the rate at which FlowFiles are transferred to follow-on processors enabling traffic simulation.</p>
  </li>
  <li>
    <p><strong>EvaluateXPath</strong> extracts the timestamp of the last update for vehicle location data returned from each FlowFile.</p>
  </li>
  <li>
    <p><strong>SplitXML</strong> splits the parent's child elements into separate FlowFiles. Since vehicle is a child element in our xml file, each new vehicle element is stored separately.</p>
  </li>
  <li>
    <p><strong>UpdateAttribute</strong> updates the attribute name for each FlowFile.</p>
  </li>
  <li>
    <p><strong>EvaluateXPath</strong> extracts attributes: vehicle id, direction latitude, longitude and speed from vehicle element in each FlowFile.</p>
  </li>
  <li>
    <p><strong>RouteOnAttribute</strong> transfers FlowFiles to follow-on processors only if vehicle ID, speed, latitude, longitude, timestamp and direction match the filter conditions.</p>
  </li>
  <li>
    <p><strong>AttributesToJSON</strong> generates a JSON representation of the attributes extracted from the FlowFiles and converts XML to JSON format this less attributes.</p>
  </li>
  <li>
    <p><strong>MergeContent</strong> merges a group of JSON FlowFiles together based on a number of FlowFiles and packages them into a single FlowFile.</p>
  </li>
</ul>

<p>Follow the step above to add these processors. You should obtain the image below:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/added_processors_nifi_part1.png" alt="added_processors_nifi_part1" /></p>

<blockquote>
  <p>Note: To find more information on the processor, right click ExecuteProcess and click <strong>usage</strong>. An in app window will appear with that processor's documentation.</p>
</blockquote>

<h3 id="troubleshoot-common-processor-issues-lab1">2.3 Troubleshoot Common Processor Issues</h3>

<p>Notice the nine processors in the image above have warning symbols <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/warning_symbol_nifi_iot.png" alt="warning_symbol_nifi_iot" /> in the upper left corner of the processor face. These warning symbols indicate the processors are invalid.</p>

<p>1. To troubleshoot, hover over one of the processors, for instance the <strong>GetFile</strong> processor, and a warning symbol will appear. This message informs us of the requirements needed, so we can run this processor.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/warning_getFile_processor_nifi_lab1.png" alt="error_getFile_processor_nifi_lab1" /></p>

<p>The warning message indicates: we need to specify a directory path to tell the processor where to pull data and a connection for the processor to establish a relationship.
Each Processor will have its own alert message. Let's configure and connect each processor to remove all the warning messages, so we can have a live data flow.</p>

<h3 id="configure--connect-processors-lab1">2.4 Configure &amp; Connect processors</h3>

<p>Now that we added some processors, we will configure our processors in the <strong>Configure Processor</strong> window, which contains 4 tabs: <strong>Settings</strong>, <strong>Scheduling</strong>, <strong>Properties</strong> and <strong>Comments</strong>. We will spend most of our time in the properties tab since it is the main place to configure specific information that the processor needs to run properly. The properties that are in bold are required for the processor to be valid. If you want more information on a particular property, hover over the help icon <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/question_mark_symbol_properties_config_iot.png" alt="question_mark_symbol_properties_config_iot.png" /> located next to the Property Name with the mouse to read a description of the property. While we configure each processor, we will also connect each processor together and establish a relationship for them to make the dataflow complete.</p>

<p>If you would like to read more about configuring and connecting processors, refer to <a href="http://docs.hortonworks.com/HDPDocuments/HDF1/HDF-1.2.0.1/bk_UserGuide/content/ch_UserGuide.html">Hortonworks Apache NiFi User Guide</a>, Building a DataFlow: section 6.2 and 6.5.</p>

<h3 id="step-3-build-xml-simulator-dataflow-section-lab1">Step 3: Build XML Simulator DataFlow Section</h3>

<h3 id="getfile">3.1 GetFile</h3>

<p>1. Download <a href="/assets/learning-ropes-nifi-lab-series/trafficLocs_data_for_simulator.zip">Traffic Simulator Data XML zip file</a>.</p>

<p>If NiFi is on Sandbox, send the zip file to the sandbox with the command:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>scp -P 2222 ~/Downloads/trafficLocs_data_for_simulator.zip root@localhost:/home/nifi/input
</code></pre>
</div>

<p>If NiFi is on local machine, create a new folder named <code class="highlighter-rouge">/home/nifi/input</code> in the <code class="highlighter-rouge">/</code> directory with the command:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>mkdir /home/nifi/input
mv ~/Downloads/trafficLocs_data_for_simulator.zip /home/nifi/input
</code></pre>
</div>

<p>Right click on the <strong>GetFile</strong> processor and click <strong>configure</strong> from dropown menu</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/configure_processor_nifi_iot.png" alt="configure_processor_nifi_iot" /></p>

<p>2. Click on the <strong>Properties</strong> tab. Add the properties listed in Table 1 to the processor's appropriate properties and if their original properties already have values, update them. Click the <strong>OK</strong> button after changing a property.</p>

<p><strong>Table 3:</strong> Update GetFile Property Values</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Input Directory</td>
      <td><code class="highlighter-rouge">/home/nifi/input</code></td>
    </tr>
    <tr>
      <td>Keep Source File</td>
      <td><code class="highlighter-rouge">true</code></td>
    </tr>
  </tbody>
</table>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/getFile_config_property_tab_window.png" alt="getFile_config_property_tab_window" /></p>

<p><strong>Figure 3:</strong> GetFile Configuration Property Tab Window</p>

<p>3. Now that each property is updated. Click <strong>Apply</strong>. Connect <strong>GetFile</strong> to <strong>UnpackPack</strong> processor. When the Create Connection window appears, verify <strong>success</strong> checkbox is checked, if not check it. Click Add.</p>

<h3 id="unpackcontent-lab1">3.2 UnpackContent</h3>

<p>1. Open the processor configuration <strong>properties</strong> tab. Add the properties listed in Table 4 and if their original properties already have values, update them.</p>

<p><strong>Table 4:</strong> Update UnpackContent Property Value</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Packaging Format</td>
      <td>zip</td>
    </tr>
  </tbody>
</table>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/unpackContent_config_property_tab_window.png" alt="unpackContent_config_property_tab_window" /></p>

<p><strong>Figure 4:</strong> UnpackContent Configuration Property Tab Window</p>

<p>2. Open the processor config <strong>Settings</strong> tab, under Auto terminate relationships, check the <strong>failure</strong> and <strong>original</strong> checkboxes. Click <strong>Apply</strong>.</p>

<p>3. Connect <strong>UnpackPack</strong> to <strong>ControlRate</strong> processor. When the Create Connection window appears, verify <strong>success</strong> checkbox is checked, if not check it. Click Add.</p>

<h3 id="controlrate-lab1">3.3 ControlRate</h3>

<p>1. Open the processor configuration <strong>properties</strong> tab. Add the properties listed in Table 5 and if their original properties already have values, update them.</p>

<p><strong>Table 5:</strong> Update ControlRate Property Values</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Rate Control Criteria</td>
      <td>flowfile count</td>
    </tr>
    <tr>
      <td>Maximum Rate</td>
      <td>1</td>
    </tr>
    <tr>
      <td>Time Duration</td>
      <td>6 second</td>
    </tr>
  </tbody>
</table>

<p><strong>Rate Control Criteria</strong> instructs the processor to count the number of FlowFile before a transfer takes place
<strong>Maximum Rate</strong> instructs the processor to transfer 1 FlowFile at a time
<strong>Time Duration</strong> makes it so only 1 flowfile will transfer through this processor every 6 seconds.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/controlRate_config_property_tab_window.png" alt="controlRate_config_property_tab_window" /></p>

<p><strong>Figure 5:</strong> ControlRate Configuration Property Tab Window</p>

<p>2. Open the processor config <strong>Settings</strong> tab, under Auto terminate relationships, check the <strong>failure</strong> checkbox. Click <strong>Apply</strong>.</p>

<p>3. Connect <strong>ControlRate</strong> to <strong>EvaluateXPath</strong> processor. When the Create Connection window appears, verify <strong>success</strong> checkbox is checked, if not check it. Click Add.</p>

<h3 id="step-4-build-key-attribute-extraction-dataflow-section-lab1">Step 4: Build Key Attribute Extraction DataFlow Section</h3>

<h3 id="evaluatexpath-lab1">4.1 EvaluateXPath</h3>

<p>1. Open the processor configuration <strong>properties</strong> tab. Add the properties listed in Table 6 and if the original properties already have values, update them. For the second property in Table 6, add a new dynamic property for XPath expression, select the <strong>New property</strong> button. Insert the following property name and value into your properties tab as shown in the table below:</p>

<p><strong>Table 6:</strong> Update EvaluateXPath Property Values</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Destination</td>
      <td>flowfile-attribute</td>
    </tr>
    <tr>
      <td>Last_Time</td>
      <td>//body/lastTime/@time</td>
    </tr>
  </tbody>
</table>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/evaluateXPath_config_property_tab_window.png" alt="evaluateXPath_config_property_tab_window" /></p>

<p><strong>Figure 6:</strong> EvaluateXPath Configuration Property Tab Window</p>

<p>3. Open the processor config <strong>Settings</strong> tab, under Auto terminate relationships, check the <strong>failure</strong> and <strong>unmatched</strong> checkboxes. Click <strong>Apply</strong>.</p>

<p>4. Connect <strong>EvaluateXPath</strong> to <strong>SplitXML</strong> processor. When the Create Connection window appears, verify <strong>matched</strong> checkbox is checked, if not check it. Click Add.</p>

<h3 id="splitxml-lab1">4.2 SplitXML</h3>

<p>1. Keep SplitXML configuration <strong>properties</strong> as default.</p>

<p>2. Connect <strong>SplitXML</strong> to <strong>UpdateAttribute</strong> processor. When the Create Connection window appears, verify <strong>split</strong> checkbox is checked, if not check it. Click Add.</p>

<h3 id="updateattribute-lab1">4.3 UpdateAttribute</h3>

<p>1. Add a new dynamic property for NiFi expression, click on the <strong>New property</strong> button. Insert the following property name and value into your properties tab as shown in the table below:</p>

<p><strong>Table 7:</strong> Add UpdateAttribute Property Value</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>filename</td>
      <td>${UUID()}</td>
    </tr>
  </tbody>
</table>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/updateAttribute_config_property_tab_window.png" alt="updateAttribute_config_property_tab_window" /></p>

<p><strong>Figure 7:</strong> UpdateAttribute Configuration Property Tab Window</p>

<p>2. Connect <strong>UpdateAttribute</strong> to <strong>EvaluateXPath</strong> processor. When the Create Connection window appears, verify <strong>success</strong> checkbox is checked, if not check it. Click Add.</p>

<h3 id="evaluatexpath-1-lab1">4.4 EvaluateXPath</h3>

<p>1. Open the processor configuration <strong>properties</strong> tab. Add the properties listed in Table 8 and if their original properties already have values, update them. For the remaining properties in Table 8, add new dynamic properties for XPath expressions, click on the <strong>New property</strong> button. Insert the following property name and value into your properties tab as shown in the table below:</p>

<p><strong>Table 8:</strong> Update EvaluateXPath Property Values</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Destination</td>
      <td>flowfile-attribute</td>
    </tr>
    <tr>
      <td>Direction_of_Travel</td>
      <td>//vehicle/@dirTag</td>
    </tr>
    <tr>
      <td>Latitude</td>
      <td>//vehicle/@lat</td>
    </tr>
    <tr>
      <td>Longitude</td>
      <td>//vehicle/@lon</td>
    </tr>
    <tr>
      <td>Vehicle ID</td>
      <td>//vehicle/@id</td>
    </tr>
    <tr>
      <td>Vehicle_Speed</td>
      <td>//vehicle/@speedKmHr</td>
    </tr>
  </tbody>
</table>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/evaluateXPath_extract_splitFlowFiles_config_property_tab.png" alt="evaluateXPath_extract_splitFlowFiles_config_property_tab" /></p>

<p><strong>Figure 8:</strong> EvaluateXPath Configuration Property Tab Window</p>

<p>2. Open the processor config <strong>Settings</strong> tab, under Auto terminate relationships, check the <strong>failure</strong> and <strong>unmatched</strong> checkboxes. Click <strong>Apply</strong>.</p>

<p>3. Connect <strong>EvaluateXPath</strong> to <strong>RouteOnAttribute</strong> processor. When the Create Connection window appears, verify <strong>matched</strong> checkbox is checked, if not check it. Click Add.</p>

<h3 id="step-5-build-filter-and-json-conversion-dataflow-section-lab1">Step 5: Build Filter and JSON Conversion DataFlow Section</h3>

<h3 id="routeonattribute-lab1">5.1 RouteOnAttribute</h3>

<p>1. Open the processor configuration <strong>properties</strong> tab. Add a new dynamic property for NiFi expression, select the <strong>New property</strong> button. Insert the following property name and value into your properties tab as shown in the table below:</p>

<p><strong>Table 9:</strong> Add RouteOnAttribute Property Value</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Filter_Attributes</td>
      <td><code class="highlighter-rouge">${Direction_of_Travel:isEmpty():not():and(${Last_Time:isEmpty()not()}):and(${Latitude:isEmpty():not()}):and(${Longitude:isEmpty():not()}):and(${Vehicle_ID:isEmpty():not()}):and(${Vehicle_Speed:equals('0'):not()})}</code></td>
    </tr>
  </tbody>
</table>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/routeOnAttribute_config_property_tab_window.png" alt="routeOnAttribute_config_property_tab_window" /></p>

<p><strong>Figure 9:</strong> RouteOnAttribute Configuration Property Tab Window</p>

<p>2. Open the processor config <strong>Settings</strong> tab, under Auto terminate relationships, check the <strong>unmatched</strong> checkbox. Click <strong>Apply</strong>.</p>

<p>3. Connect <strong>RouteOnAttribute</strong> to <strong>AttributesToJSON</strong> processor. When the Create Connection window appears, verify <strong>Filter_Attributes</strong> checkbox is checked, if not check it. Click Add.</p>

<h3 id="attributestojson-lab1">5.2 AttributesToJSON</h3>

<p>1. Open the processor configuration <strong>properties</strong> tab. Add the properties listed in Table 10 and if their original properties already have values, update them.</p>

<p><strong>Table 10:</strong> Update AttributesToJSON Property Values</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Attributes List</td>
      <td><code class="highlighter-rouge">Vehicle_ID, Direction_of_Travel, Latitude, Longitude, Vehicle_Speed, Last_Time</code></td>
    </tr>
    <tr>
      <td>Destination</td>
      <td>flowfile-content</td>
    </tr>
  </tbody>
</table>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/attributesToJSON_config_property_tab_window.png" alt="attributesToJSON_config_property_tab_window" /></p>

<p><strong>Figure 10:</strong> AttributesToJSON Configuration Property Tab Window</p>

<p>3. Open the processor config <strong>Settings</strong> tab, under Auto terminate relationships, check the <strong>failure</strong> checkbox. Click <strong>Apply</strong>.</p>

<p>4. Connect <strong>AttributesToJSON</strong> to <strong>MergeContent</strong> processor. When the Create Connection window appears, verify <strong>success</strong> checkbox is checked, if not check it. Click Add.</p>

<h3 id="mergecontent-lab1">5.3 MergeContent</h3>

<p>1. Open the processor configuration <strong>properties</strong> tab. Add the properties listed in Table 11 and if their original properties already have values, update them.</p>

<p><strong>Table 11:</strong> Update MergeContent Property Values</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Minimum Number of Entries</td>
      <td>10</td>
    </tr>
    <tr>
      <td>Maximum Number of Entries</td>
      <td>15</td>
    </tr>
    <tr>
      <td>Filename</td>
      <td><code class="highlighter-rouge">Text</code></td>
    </tr>
    <tr>
      <td>Header</td>
      <td><code class="highlighter-rouge">[</code></td>
    </tr>
    <tr>
      <td>Footer</td>
      <td><code class="highlighter-rouge">]</code></td>
    </tr>
  </tbody>
</table>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/mergeContent_firstHalf_config_property_tab_window.png" alt="mergeContent_firstHalf_config_property_tab_window" /></p>

<p><strong>Figure 11a:</strong> MergeContent First Half of Configuration Property Tab Window</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/mergeContent_secondHalf_config_property_tab_window.png" alt="mergeContent_secondHalf_config_property_tab_window" /></p>

<p><strong>Figure 11b:</strong> MergeContent Second Half of Configuration Property Tab Window</p>

<p>3. Open the processor config <strong>Settings</strong> tab, under Auto terminate relationships, check the <strong>failure</strong> and <strong>original</strong> checkboxes. Click <strong>Apply</strong>.</p>

<p>4. Connect <strong>MergeContent</strong> to <strong>PutFile</strong> processor. When the Create Connection window appears, verify <strong>merged</strong> checkbox is checked, if not check it. Click Add.</p>

<h3 id="putfile-lab1">5.4 PutFile</h3>

<p>1. Open the processor configuration <strong>properties</strong> tab. Add the property listed in Table 12 and if their original property already has a value, update it.</p>

<p><strong>Table 12:</strong> Update PutFile Property Value</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Directory</td>
      <td><code class="highlighter-rouge">/home/nifi/output/filtered_transitLoc_data</code></td>
    </tr>
  </tbody>
</table>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/putFile_config_property_tab_window.png" alt="putFile_config_property_tab_window" /></p>

<p><strong>Figure 12:</strong> PutFile Configuration Property Tab Window</p>

<p>3. Open the processor config <strong>Settings</strong> tab, under Auto terminate relationships, check the <strong>failure</strong> and <strong>success</strong> checkboxes. Click <strong>Apply</strong>.</p>

<h3 id="step-6-run-the-nifi-dataflow-lab1">Step 6: Run the NiFi DataFlow</h3>

<p>1. The processors are valid since the warning symbols disappeared. Notice that the processors have a red stop symbol <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/stop_symbol_nifi_iot.png" alt="stop_symbol_nifi_iot" /> in the upper left corner and are ready to run. To select all processors, hold down the <strong>shift-key</strong> and drag your mouse across the entire data flow.</p>

<p>2. Now that all processors are selected, go to the actions toolbar and click the start button <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/start_button_nifi_iot.png" alt="start_button_nifi_iot" />. Your screen should look like the following:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/run_dataflow_lab1_nifi_learn_ropes.png" alt="run_dataflow_lab1_nifi_learn_ropes" /></p>

<p>3. To quickly see what the processors are doing and the information on their faces, right click on the graph, click the <strong>refresh status</strong> button <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/refresh_nifi_iot.png" alt="refresh_nifi_iot" /></p>

<p>4. To check that the data was written to a file, open your terminal. Make sure to SSH into your sandbox. Navigate to the directory you wrote for the PutFile processor. List the files and open one of the newly created files to view filtered transit output. In the tutorial our directory path is: <code class="highlighter-rouge">/home/nifi/output/filtered_transitLoc_data</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd /home/nifi/output/filtered_transitLoc_data
ls
vi 22169558941607
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/commands_enter_sandbox_shell_lab1.png" alt="commands_enter_sandbox_shell_lab1" /></p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab1-build-nifi-dataflow/filtered_vehicle_locations_data_nifi_learn_ropes.png" alt="filtered_vehicle_locations_data_nifi_learn_ropes" /></p>

<blockquote>
  <p>Note: to exit the vi editor, press <code class="highlighter-rouge">esc</code> and then type <code class="highlighter-rouge">:q</code>.</p>
</blockquote>

<p>Did you receive the data you expected?</p>

<h2 id="summary-lab1">Summary</h2>

<p>Congratulations! You made it to the end of the tutorial and built a NiFi DataFlow that reads in a live stream simulation from NextBus.com, splits the parent's children elements from the XML file into separate FlowFiles, extracts nodes from the XML file, makes a filtering decision on the attributes and stores that newly modified data into a file. If you are interested in learning more about NiFi, view the following further reading section.</p>

<p>If you want a more in depth review of the dataflow we just built, read the information below, else continue onto the next lab.</p>

<p>Vehicle Location XML Simulation Section:
streams the contents of a file from local disk into NiFi, unpacks the zip file and transfers each file as a single FlowFile, controls the rate at which the data flows to the remaining part of the flow.</p>

<p>Extract Attributes From FlowFiles Section:
Splits XML message into many FlowFiles, updates each FlowFile filename attribute with unique name and User Defined XPath Expressions are evaluated against the XML Content to extract the values into user-named Attribute.</p>

<p>Filter Key Attributes to JSON File Section:
Routes FlowFile based on whether it contains all XPath Expressions (attributes) from the evaluation, writes JSON representation of input attributes to FlowFile as content, merges the FlowFiles by concatenating their content together into a single FlowFile and writes the contents of a FlowFile to a directory on the local filesystem.</p>

<h2 id="further-reading-lab1">Further Reading</h2>

<ul>
  <li><a href="http://docs.hortonworks.com/HDPDocuments/HDF1/HDF-1.2/bk_UserGuide/content/index.html">Hortonworks DataFlow Documentation</a></li>
  <li><a href="https://nifi.apache.org/docs/nifi-docs/html/expression-language-guide.html">NiFi Expression Language Guide</a></li>
  <li><a href="https://nifi.apache.org/videos.html">Apache NiFi</a></li>
</ul>

</div>

<div id="tutorial-footer-lab1">
  <hr>
  <h2>Tutorial Q&amp;A and Reporting Issues</h2>
  <p>If you need help or have questions with this tutorial, please first check HCC for existing Answers to questions on this tutorial using the Find Answers button.  If you don't find your answer you can post a new HCC question for this tutorial using the Ask Questions button.</p>
  <p><a class="btn" href="https://community.hortonworks.com/topics/tutorial-640.html" role="button">Find Answers</a> <a class="btn pull-right" href="https://community.hortonworks.com/questions/ask.html?space=81&topics=tutorial-640&topics=hdp-2.4.0" role="button">Ask Questions</a></p>
  <p>Tutorial Name: <strong>Lab 1 Build A Simple NiFi DataFlow</strong></p>
  <p>HCC Tutorial Tag:<strong> tutorial-640</strong> and <strong>hdp-2.4.0</strong></p>
  <p>If the tutorial has multiple labs please indicate which lab your question corresponds to. Please provide any feedback related to that lab.</p>
  <p>All Hortonworks, partner and community tutorials are posted in the Hortonworks github and can be contributed via the <a href="https://github.com/hortonworks/tutorials/wiki">Hortonworks Tutorial Contribution Guide</a>.  If you are certain there is an issue or bug with the tutorial, please <a href="https://github.com/hortonworks/tutorials/wiki#issues-with-tutorials">create an issue</a> on the repository and we will do our best to resolve it!</p>
</div>
