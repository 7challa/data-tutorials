

<div class="tutorial-content">
  <h1 id="analyze-twitter-data-with-apache-nifi-and-hdp-search">Analyze Twitter Data With Apache NiFi and HDP Search</h1>

<h3 id="introduction">Introduction</h3>

<p>In this tutorial, we will learn to install Apache NiFi on your Hortonworks Sandbox if you do not have it pre-installed already. Using NiFi, we create a data flow to pull tweets directly from the <a href="https://dev.twitter.com/overview/documentation">Twitter API</a>.</p>

<p>We will use <a href="http://hortonworks.com/hadoop/solr/">Solr</a> and the <a href="http://hortonworks.com/press-releases/hortonworks-partners-lucidworks-bring-search-big-data/">LucidWorks HDP Search</a> to view our streamed data in realtime to gather insights as the data arrives in our Hadoop cluster.</p>

<p>Next, we will use Hive to analyze the social sentiment after we have finished collecting our data from NiFi.</p>

<p>Finally, we will use <a href="http://hortonworks.com/hadoop/zeppelin/">Apache Zeppelin</a> to create charts, so we can visualize our data directly inside of our Hadoop cluster.</p>

<h3 id="list-of-technologies-in-this-tutorial">List of technologies in this tutorial:</h3>

<ul>
  <li><a href="http://hortonworks.com/products/hortonworks-sandbox/">Hortonworks Sandbox</a></li>
  <li><a href="http://hortonworks.com/products/dataflow/">Apache NiFi</a></li>
  <li><a href="http://hortonworks.com/press-releases/hortonworks-partners-lucidworks-bring-search-big-data/">Solr + LucidWorks HDP Search</a></li>
  <li><a href="http://hortonworks.com/hadoop/hive/">Hive and Ambari Views</a></li>
  <li><a href="http://hortonworks.com/hadoop/zeppelin/">Apache Zeppelin</a></li>
  <li><a href="https://dev.twitter.com/">Twitter API</a></li>
</ul>

<h2 id="pre-requisites">Pre-Requisites</h2>

<ul>
  <li>Downloaded and Installed the <a href="http://hortonworks.com/hdp/downloads/">Hortonworks Sandbox with HDP</a></li>
  <li><a href="http://hortonworks.com/hadoop-tutorial/learning-the-ropes-of-the-hortonworks-sandbox/">Learning the Ropes of the Hortonworks Sandbox</a></li>
  <li><a href="http://hortonworks.com/hadoop-tutorial/deploying-hortonworks-sandbox-on-microsoft-azure/">Deploying Hortonworks Sandbox on Microsoft Azure</a></li>
</ul>

<h2 id="outline">Outline</h2>

<ol>
  <li><a href="#install-apache-nifi">Install Apache NiFi</a></li>
  <li><a href="#configure-and-start-solr">Configure and Start Solr</a></li>
  <li><a href="#creating-a-twitter-application">Create a Twitter Application</a></li>
  <li><a href="#creating-a-data-flow-with-nifi">Create a Data Flow with Nifi</a></li>
  <li><a href="#generating-random-tweet-data-for-hive-and-solr">(Optional) Generating Random Twitter Data</a></li>
  <li><a href="#analyze-and-search-data-with-solr">Analyze and Search Data with Solr</a></li>
  <li><a href="#analyzing-tweet-data-in-hive">Analyze Tweet Data in Hive</a></li>
  <li><a href="#visualizing-sentiment-with-zeppelin">Visualize Sentiment with Zeppelin</a></li>
</ol>

<hr />

<h2 id="install-apache-nifi-">Install Apache Nifi <a id="install-apache-nifi"></a></h2>
<hr />

<p>The first thing you're going to need if you haven't done it already is install the Apache Nifi service on your Sandbox. Follow the <a href="http://hortonworks.com/hadoop-tutorial/learning-ropes-apache-nifi/#section_3">Set up Nifi Environment section</a> of <a href="http://hortonworks.com/hadoop-tutorial/learning-ropes-apache-nifi/">Analyze Traffic Pattern with Apache Nifi</a>.</p>

<h2 id="configure-and-start-solr-">Configure and Start Solr <a id="configure-and-start-solr"></a></h2>

<p>Make sure that Ambari Infra is stopped, we now need to install HDP Search.</p>

<p>Login to Ambari user credentials: Username - <strong>raj_ops</strong> and Password - <strong>raj_ops</strong>. Click on Actions button at the bottom and then Add Service:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/actions_button.png" alt="actions_button" /></p>

<p>Next, you will view a list of services that you can add. Scroll to the bottom and select <code class="highlighter-rouge">Solr</code>, then press <code class="highlighter-rouge">Next</code>.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/check_solr.png" alt="check_solr" /></p>

<p>Accept all default values in next few pages, and then you can see the progress of your installation:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/solr_progress.png" alt="solr_progress" /></p>

<p>After a minute, you can see Solr successfully installed:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/solr_install_success.png" alt="solr_install_success" /></p>

<p>Press Next, you will be asked to restart some services. Restart HDFS, YARN, Mapreduce2 and HBase.</p>

<p>We just need to make a few quick changes.</p>

<p>Open your terminal shell and SSH back into the sandbox. We're going to need to run the following commands as the <strong>solr</strong> user. run</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>su solr
</code></pre>
</div>

<p>Then we need to edit the following file path to make sure that Solr can recognize a tweet's timestamp format. First we're going to copy the config set over to twitter's <strong>tweet_configs</strong> folder:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>cp -r /opt/lucidworks-hdpsearch/solr/server/solr/configsets/data_driven_schema_configs /opt/lucidworks-hdpsearch/solr/server/solr/configsets/tweet_configs
</code></pre>
</div>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>vi /opt/lucidworks-hdpsearch/solr/server/solr/configsets/tweet_configs/conf/solrconfig.xml
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/su_solr.png" alt="su_solr" /></p>

<p>Once the file is opened in <code class="highlighter-rouge">vi</code> type</p>

<p><strong>Note</strong> In <strong>vi</strong> the command below should not be run in <strong>INSERT</strong> mode.  <code class="highlighter-rouge">/</code> will do a find for the text that you type after it.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/solr.ParseDateFieldUpdateProcessorFactory
</code></pre>
</div>

<p>This will bring you to the part of the config where we need to add the following:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;str&gt;</span>EEE MMM d HH:mm:ss Z yyyy<span class="nt">&lt;/str&gt;</span>
</code></pre>
</div>

<p>Make sure this is inserted just above all of the other <code class="highlighter-rouge">&lt;str&gt;</code> tags.</p>

<p><strong>Note</strong> In <code class="highlighter-rouge">vi</code>, to type or insert anything you must be in <em>insert mode</em>. Press <code class="highlighter-rouge">i</code> on your keyboard to enter insert mode in <code class="highlighter-rouge">vi</code>.</p>

<p>After inserting the above, the portion of the file should look something like this:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;processor</span> <span class="na">class=</span><span class="s">"solr.ParseLongFieldUpdateProcessorFactory"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;processor</span> <span class="na">class=</span><span class="s">"solr.ParseDateFieldUpdateProcessorFactory"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;arr</span> <span class="na">name=</span><span class="s">"format"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;str&gt;</span>EEE MMM d HH:mm:ss Z yyyy<span class="nt">&lt;/str&gt;</span>
      <span class="nt">&lt;str&gt;</span>yyyy-MM-dd'T'HH:mm:ss.SSSZ<span class="nt">&lt;/str&gt;</span>
      <span class="nt">&lt;str&gt;</span>yyyy-MM-dd'T'HH:mm:ss,SSSZ<span class="nt">&lt;/str&gt;</span>
      <span class="nt">&lt;str&gt;</span>yyyy-MM-dd'T'HH:mm:ss.SSS<span class="nt">&lt;/str&gt;</span>
      <span class="nt">&lt;str&gt;</span>yyyy-MM-dd'T'HH:mm:ss,SSS<span class="nt">&lt;/str&gt;</span>
      <span class="nt">&lt;str&gt;</span>yyyy-MM-dd'T'HH:mm:ssZ<span class="nt">&lt;/str&gt;</span>
      <span class="nt">&lt;/arr&gt;</span>
    <span class="nt">&lt;/processor&gt;</span>
<span class="nt">&lt;/processor&gt;</span>
</code></pre>
</div>

<p>Finally press the <strong>Escape key</strong> on your keyboard and type <code class="highlighter-rouge">:wq</code> to save and close the <code class="highlighter-rouge">solrconfig.xml</code> file.</p>

<p>Next we need to replace a JSON file. Use the following commands to move the original and download the replacement file:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">cd</span> /opt/lucidworks-hdpsearch/solr/server/solr-webapp/webapp/banana/app/dashboards/

mv default.json default.json.orig

wget https://raw.githubusercontent.com/abajwa-hw/ambari-nifi-service/master/demofiles/default.json
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/wget_json.png" alt="wget_json" /></p>

<p>Then we are going to add a collection called "tweets"</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>/opt/lucidworks-hdpsearch/solr/bin/solr create -c tweets -d tweet_configs -s 1 -rf 1 -p 8983
</code></pre>
</div>

<blockquote>
  <p>Note: Here -c indicates the name
-d is the config directory
-s is the number of shards
-rf is the replication factor
-p is the port at which Solr is running</p>
</blockquote>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/add_collection_tweets_sentiment_analysis.png" alt="add collection tweets" /></p>

<p>We can now go back to running commands as the <strong>root</strong> user. Run</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">exit</span>
</code></pre>
</div>

<p>This will log you out of the <code class="highlighter-rouge">solr</code> user</p>

<p>Great! Now Solr should be installed and running on your sandbox!</p>

<p>Ensure that you can access the Solr UI by navigating to <a href="http://sandbox.hortonworks.com:8983/solr/">http://sandbox.hortonworks.com:8983/solr/</a></p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/08_solr_ui.png" alt="Solr UI" /></p>

<h2 id="create-a-twitter-application-">Create a Twitter Application <a id="creating-a-twitter-application"></a></h2>

<p>If you would rather not register your own Twitter application and use previous data, please head to the <a href="#analyze-and-search-data-with-solr">next section</a> where you can download the sample dataset.</p>

<p>If you want to pull live data from Twitter in this tutorial you'll need to register your own Twitter application. It's quite simple and only takes a few short steps</p>

<p>First head over to the <a href="http://apps.twitter.com">Twitter Apps Website</a> and Sign In using your Twitter account (or make one if you don't have one yet!)</p>

<p>Then click <strong>Create a New App</strong>.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/09_create_twitter_app.png" alt="Creating Twitter App" /></p>

<p>After you've clicked that you'll need to fill in some details about your application. Feel free to put whatever you want.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/10_twitter_app_details.png" alt="Twitter App Details" /></p>

<p>Then click <strong>Create Your Twitter Application</strong> at the bottom of the screen after reading the developer agreement.</p>

<blockquote>
  <p><strong>Note</strong> that you might need to add your mobile phone to your Twitter account before creating your application</p>
</blockquote>

<p>Once you've done that you should be greeted by a dashboard for your Twitter application. Head over to the permissions tab and select the <strong>Read Only</strong> Option and <strong>Update</strong> your application.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/11_changing_app_permissions.png" alt="Changing App Permission" /></p>

<p>Finally you need to generate your OAuth key. You can do this by clicking <strong>Test OAuth</strong> on the top of the permissions page, or by heading to <strong>Keys and Access Tokens</strong> and then finding the option that allows you to generate your OAuth tokens.</p>

<p>Finally, your keys and access tokens should look similar to the following:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/12_twitter_app_tokens.png" alt="Twitter Tokens" /></p>

<p>Please make note of your <strong>Consumer Key</strong>, <strong>Consumer Secret</strong>, <strong>Access Token</strong>, and <strong>Access Token Secret</strong>. You will need these to create the data flow in NiFi.</p>

<h2 id="create-a-data-flow-with-nifi-">Create a Data Flow with NiFi <a id="creating-a-data-flow-with-nifi"></a></h2>

<p>The first thing you'll need to do here is download the NiFi data flow template for the <a href="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/assets/Twitter_JSON_Flow.xml">Twitter Dashboard here</a></p>

<p>Make note of where you download this file. You'll need it in the next step.</p>

<p>Open up the NiFi user interface found at <a href="http://sandbox.hortonworks.com:9090/nifi">http://sandbox.hortonworks.com:9090/nifi</a>. Then you'll need to import the template you just downloaded into NiFi.</p>

<p>Import the template by clicking <code class="highlighter-rouge">Templates</code> icon in the right of the Operate box.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/click_import_template.png" alt="click_import_template" /></p>

<p>Then click <strong>on the search sign</strong> to select the template and navigate to the <code class="highlighter-rouge">Twitter_JSON_Flow.xml</code> file that you just previously downloaded.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/search_template.png" alt="search_template" /></p>

<p>Once you've selected the file you can click <strong>UPLOAD</strong>.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/upload_template_json.png" alt="upload_template_json" /></p>

<p>You should now see the Success message that your file is uploaded, press <strong>OK</strong></p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/template_uploaded.png" alt="template_uploaded" /></p>

<p>Now that we've got the template imported into NiFi we can instantiate it. Drag the template icon (the 7th from the left) onto the workspace.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/drag_template.png" alt="drag_template" /></p>

<p>Then a dialog box should appear. Make sure that <strong>Twitter_JSON_Flow</strong> is selected and click <strong>Add</strong>.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/add_template_json.png" alt="add_template_json" /></p>

<p>After clicking <strong>ADD</strong> you should have a screen similar to the following:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/work_flow.png" alt="work_flow" /></p>

<p>Great! The NiFi flow has been set up. The <em>boxes</em> are what NiFi calls processors. Each of the processors can be connected to one another and help make data flow. Each processor can perform specific tasks. They are at the very heart of NiFi's functionality.</p>

<p><strong>Note!</strong> You can make you flows looks very clean by having the connections between all of your processors at 90 degree angles with respect to one another. You can do this by <a href="https://community.hortonworks.com/content/kbentry/1828/tip-bend-those-connections.html"><strong>double clicking a connection arrow to create a vertex</strong></a>. This will allow you to customize the look of your flow</p>

<p>Try <strong>right-clicking</strong> on a few of the the processors and look at their configuration. This can help you better understand how the Twitter flow works.</p>

<p>Now we'll need to configure the Twitter Hose processor with the access tokens that we made earlier for our Twitter application.</p>

<p>Right click on the <strong>Grab Garden Hose</strong> element and click <strong>Configure</strong></p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/grab_garden.png" alt="grab_garden" /></p>

<p>Then you're going to need to place all of those Twitter API tokens from earlier in their respective places. Then hit <strong>Apply</strong>.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/configure_processor.png" alt="configure_processor" /></p>

<p>Once you've got all of your properties set up you can take a look at the configurations of some of the other processors in our data.</p>

<p>The processors are valid since the warning symbols disappeared. Notice that the processors have a stop symbol <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/stop_signal.png" alt="stop_signal" /> in the upper left corner and are ready to run. To select all processors, hold down the shift-key and drag your mouse across the entire data flow.</p>

<p>Now that all processors are selected, go to the actions toolbar and click the start button <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/play_signal.png" alt="play_signal" />. You can see your workflow running.</p>

<h2 id="generating-random-tweet-data-for-hive-and-solr-">Generating Random Tweet Data for Hive and Solr <a id="generating-random-tweet-data-for-hive-and-solr"></a></h2>

<p>This section is for anyone who didn't want to set up a Twitter app so they could stream custom data. We're just going to use a script to generate some data and then put that into Hive and Solr. Skip to the next section if you have already set up NiFi to collect tweets.</p>

<p>First you'll need to SSH into the sandbox execute the following command</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>wget https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/nifi-sentiment-analytics/assets/twitter-gen.sh
</code></pre>
</div>

<p>Then run the command with your specified number of tweets that you would like to generate.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>bash twitter-gen.sh <span class="o">{</span>NUMBER_OF_TWEETS<span class="o">}</span>
</code></pre>
</div>

<p>Example:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>bash twitter-gen.sh 2000
</code></pre>
</div>

<p>The script will generate the data and put it in the directory <code class="highlighter-rouge">/tmp/data/</code></p>

<p>You can now continue on with the rest of the tutorial.</p>

<h2 id="analyze-and-search-data-with-solr-">Analyze and Search Data with Solr <a id="analyze-and-search-data-with-solr"></a></h2>
<hr />

<p>Now that we have our data in HDP-Search/Solr we can go ahead and start searching through our data.
If you are using NiFi to stream the data you can head over to the Banana Dashboard at <a href="http://sandbox.hortonworks.com:8983/solr/banana/index.html">http://sandbox.hortonworks.com:8983/solr/banana/index.html</a></p>

<p>The dashboard was designed by the <code class="highlighter-rouge">default.json</code> file that we had downloaded previously. You can find more about <a href="https://github.com/LucidWorks/banana">Banana here</a></p>

<p>You should be able to see the constant flow of data here and you can analyze some of it as it is dropped into the Solr index from NiFi. Try exploring the charts and see what each one does. It should be important to note that all of the graphs on the page include data that was queried straight from Solr to create those images using <a href="http://d3js.org/">d3.js</a>. You can see the queries for each graph by clicking the small <strong>gear icon</strong> located in each box.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/23_solr_banana_dashboard.png" alt="Banana Dashboard" /></p>

<p><strong>Note</strong> If you didn't use NiFi to import the data from Twitter then you won't see anything on the dashboard.</p>

<p>Let's go do some custom search on the data! Head back to the normal Solr dashboard at <a href="http://sandbox.hortonworks.com:8983/solr">http://sandbox.hortonworks.com:8983/solr</a></p>

<p>Select the <strong>tweets shard</strong> that we created before from the <code class="highlighter-rouge">Core Selector</code> menu on the bottom left of the screen.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/24_solr_core_selector.png" alt="Solr Core Selector" /></p>

<p>Once you've selected the tweets shard we can take a look to see what Solr has done with our data.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/25_solr_tweets_index.png" alt="Solr Tweets Index" /></p>

<ol>
  <li>We can see how many documents or records have been stored into this index in Solr. As long as NiFi continues to run this number will become larger as more data is ingested. If you used the <code class="highlighter-rouge">twitter-gen.sh</code> script then this number should be close to the amount of tweets that you generated.</li>
  <li>Here we can see the size on the disk that the data is taking up in Solr. We don't have many tweets collected yet, so this number is quite small.</li>
  <li>On the left side bar there are a number of different tabs to view the data that's stored within Solr. We're going to focus on the <strong>Query</strong> one, but you should explore the others as well.</li>
</ol>

<p>Click on the query tab, and you should be brought to screen similar to the following:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/26_solr_query_1.png" alt="Solr Query Dash" /></p>

<p>We're only going to be using 3 of these fields before we execute any queries, but let's quickly outline the different query parameters</p>

<ul>
  <li><strong>fq</strong>: This is a filter query parameter it lets us retrieve data that only contains certain values that we're looking for. Example: we can specify that we only want tweets after a certain time to be returned.</li>
  <li><strong>sort</strong>: self-explanatory. You can sort by a specified field in ascending or descending order. we could return all tweets by alphabetical order of Twitter handles, or possible by the time they were tweeted as well.</li>
  <li><strong>start, rows</strong>: This tells us where exactly in the index we should start searching, and how many rows should be returned when we execute the query. The defaults for each of these is <code class="highlighter-rouge">0</code> and <code class="highlighter-rouge">10</code> respectively.</li>
  <li><strong>fl</strong>: Short for <em>field list</em> specify which fields you want to be returned. If the data many, many fields, you can choose to specify only a few that are returned in the query.</li>
  <li><strong>df</strong>: Short for <em>default fields</em> you can tell which fields solr should be searching in. You will not need this if the query fields are already defined.</li>
  <li><strong>Raw Query Params</strong>: These will be added directly the the url that is requested when Solr send the request with all of the query information.</li>
  <li><strong>wt</strong>: This is the type of data that solr will return. We can specify many things such as JSON, XML, or CSV formatting.</li>
</ul>

<p>We aren't going to worry about the rest of the flags. Without entering any parameters click <strong>Execute Query</strong>.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/27_solr_query_results_1.png" alt="Solr Query Results 1" /></p>

<p>From this you should be able to view all of the tweet data that is collected. Try playing with some of the parameters and add more to the <strong>rows</strong> value in the query to see how many results you can obtain.</p>

<p>Now let's do a real query and see if we can find some valuable data.</p>

<ul>
  <li>For <strong>q</strong> type <code class="highlighter-rouge">language_s:en</code></li>
  <li>For <strong>sort</strong> type <code class="highlighter-rouge">screenName_s asc</code></li>
  <li>For <strong>rows</strong> type <code class="highlighter-rouge">150</code></li>
  <li>For <strong>fl</strong> type <code class="highlighter-rouge">screenName_s, text_t</code></li>
  <li>For <strong>wt</strong> choose <code class="highlighter-rouge">csv</code></li>
</ul>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/28_solr_query_results_2.png" alt="Solr Query Results 2" /></p>

<p>Let's try one last query. This time you can omit the <strong>sort</strong> field and chooses whichever <strong>wt</strong> format you like. Keep the <strong>fl</strong> parameter as is though.</p>

<ul>
  <li>Specify an <strong>fq</strong> parameter as <code class="highlighter-rouge">language_s:en</code></li>
  <li>In the query box, pick any keyword. I am going to use <code class="highlighter-rouge">stock</code></li>
</ul>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/29_solr_query_results_3.png" alt="Solr Query Results 3" /></p>

<p><strong>Further Reading</strong></p>

<ul>
  <li>For more information on Solr you can <a href="http://hortonworks.com/hadoop/solr/">go here</a></li>
  <li>You can also visit the <a href="http://lucene.apache.org/solr/">Apache project Page</a></li>
</ul>

<h2 id="analyze-tweet-data-in-hive-">Analyze Tweet Data in Hive <a id="analyzing-tweet-data-in-hive"></a></h2>
<hr />

<p>Now that we've taken a look at some of our data and searched it with Solr, let's see if we can refine it a bit more.</p>

<p>But before moving ahead, let us setup <strong>Hive-JSON-Serde</strong> to read the data in <strong>JSON</strong> format.<br />
We have to use the maven to compile the serde. Go back to the terminal and follow the below steps to setup the maven:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>wget http://mirror.olnevhost.net/pub/apache/maven/binaries/apache-maven-3.2.1-bin.tar.gz
</code></pre>
</div>

<p>Now, extract this file:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>tar xvf apache-maven-3.2.1-bin.tar.gz
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/install_maven.png" alt="install_maven" /></p>

<p>Now since our maven is installed, let us download the Hive-JSON-Serde. Type the following command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/rcongiu/Hive-JSON-Serde
</code></pre>
</div>

<p>This command must have created the new directory, go inside to that directory using cd:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd Hive-JSON-Serde
</code></pre>
</div>

<p>Next, run the command to compile the serde:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>./../apache-maven-3.2.1/bin/mvn -Phdp23 clean package
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/install_json_serde.png" alt="install_json_serde" /></p>

<p>Wait for its completion, and then you have to copy the serde jar to the Hive lib:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cp json-serde/target/json-serde-1.3.8-SNAPSHOT-jar-with-dependencies.jar /usr/hdp/2.5.0.0-1245/hive/lib
cp json-serde/target/json-serde-1.3.8-SNAPSHOT-jar-with-dependencies.jar /usr/hdp/2.5.0.0-1245/hive2/lib
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/copy_jars.png" alt="copy_jars" /></p>

<p><strong>DO NOT</strong> forget to Restart Hive from Ambari,</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/restart_hive.png" alt="restart_hive" /></p>

<p>We're going to attempt to get the sentiment of each tweet by matching the words in the tweets with a sentiment dictionary. From this we can determine the sentiment of each tweet and analyze it from there.</p>

<p>First off, if your Twitter flow on the NiFi instance is still running, you'll need to shut it off. Open up the NiFi dashboard at <a href="http://sandbox.hortonworks.com:9090/nifi">sandbox.hortonworks.com:9090/nifi</a> and click stop square <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/stop_signal.png" alt="stop_signal" /> at the top of the screen.</p>

<p>Next, you'll need to SSH into the sandbox again and run the following two commands</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># Virtualbox  </span>
	sudo -u hdfs hadoop fs -chown -R maria_dev /tmp/tweets_staging
	sudo -u hdfs hadoop fs -chmod -R 777 /tmp/tweets_staging
<span class="c"># Azure	    </span>
	sudo -u hdfs hadoop fs -chown -R azure /tmp/tweets_staging
	sudo -u hdfs hadoop fs -chmod -R 777 /tmp/tweets_staging
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/change_permissions_tweets_staging_sentiment_analysis.png" alt="change permission of tweets staging" /></p>

<p>After the commands complete let's go to the Hive view. Head over to <a href="http://sandbox.hortonworks.com:8080/">http://sandbox.hortonworks.com:8080</a>. Login into Ambari. Refer to <a href="http://hortonworks.com/hadoop-tutorial/learning-the-ropes-of-the-hortonworks-sandbox/">Learning the Ropes of the Hortonworks Sandbox</a> if you need assistance with logging into Ambari.</p>
<blockquote>
  <p><strong>Note:</strong> login credentials are <code class="highlighter-rouge">maria_dev/maria_dev</code> (Virtualbox), else <code class="highlighter-rouge">azure/azure</code> (Azure). Use the dropdown menu at the top to get to the Hive view.</p>
</blockquote>

<p>Execute the following command to create a table for the tweets</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CREATE EXTERNAL TABLE IF NOT EXISTS tweets_text(
  tweet_id bigint,
  created_unixtime bigint,
  created_time string,
  lang string,
  displayname string,
  time_zone string,
  msg string)
ROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe'
LOCATION '/tmp/tweets_staging';
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/create_table_json.png" alt="create_table_json" /></p>

<p>Now we're going to need to do some data analysis.</p>

<p>First you're going to need to head to the <strong>HDFS Files View</strong> and create a new directory in <code class="highlighter-rouge">/tmp/data/tables</code></p>

<p>Then create two new directories inside of <code class="highlighter-rouge">/tmp/data/tables</code>. One named <strong>time_zone_map</strong> and another named <strong>dictionary</strong></p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/two_new_tweet_dir_sentiment_analysis.png" alt="Data Table Folders" /></p>

<p>In each of the folders respectively you'll need to upload the <a href="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/assets/dictionary.tsv"><code class="highlighter-rouge">dictionary.tsv</code> file</a>, and the <a href="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/assets/time_zone_map.tsv"><code class="highlighter-rouge">time_zone_map.tsv</code> file</a> to each of their respective directories.</p>

<p>After doing so, you'll need to run the following command on the Sandbox:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo -u hdfs hadoop fs -chmod -R 777 /tmp/data/tables
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/modify_permissions_tables_dir_sentiment_analysis.png" alt="modify permissions tables folder" /></p>

<p>Finally, run the following two commands:</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="k">dictionary</span> <span class="p">(</span>
	<span class="k">type</span> <span class="n">string</span><span class="p">,</span>
	<span class="k">length</span> <span class="n">int</span><span class="p">,</span>
	<span class="n">word</span> <span class="n">string</span><span class="p">,</span>
	<span class="n">pos</span> <span class="n">string</span><span class="p">,</span>
	<span class="n">stemmed</span> <span class="n">string</span><span class="p">,</span>
	<span class="n">polarity</span> <span class="n">string</span> <span class="p">)</span>
<span class="k">ROW</span> <span class="n">FORMAT</span> <span class="n">DELIMITED</span>
<span class="n">FIELDS</span> <span class="n">TERMINATED</span> <span class="k">BY</span> <span class="s1">'</span><span class="se">\t</span><span class="s1">'</span>
<span class="n">STORED</span> <span class="k">AS</span> <span class="n">TEXTFILE</span>
<span class="k">LOCATION</span> <span class="s1">'/tmp/data/tables/dictionary'</span><span class="p">;</span>
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/create_dictionary_table_sentiment_analysis.png" alt="create dictionary table" /></p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">time_zone_map</span> <span class="p">(</span>
    <span class="n">time_zone</span> <span class="n">string</span><span class="p">,</span>
    <span class="n">country</span> <span class="n">string</span><span class="p">,</span>
    <span class="n">notes</span> <span class="n">string</span> <span class="p">)</span>
<span class="k">ROW</span> <span class="n">FORMAT</span> <span class="n">DELIMITED</span>
<span class="n">FIELDS</span> <span class="n">TERMINATED</span> <span class="k">BY</span> <span class="s1">'</span><span class="se">\t</span><span class="s1">'</span>
<span class="n">STORED</span> <span class="k">AS</span> <span class="n">TEXTFILE</span>
<span class="k">LOCATION</span> <span class="s1">'/tmp/data/tables/time_zone_map'</span><span class="p">;</span>
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/create_time_zone_map_table_sentiment_analysis.png" alt="create time zone map table" /></p>

<p>This will create two tables from that data which we will use to analyze the tweet sentiment. They should appear in the <strong>database explorer</strong> as shown below.</p>

<blockquote>
  <p><strong>Note</strong> Refresh page if explorer doesn't appear automatically.</p>
</blockquote>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/32_hive_table_db_explorer.png" alt="Data Table Folders" /></p>

<p>Next we'll need to create two table views from our tweets which will simplify the columns the data we have access to.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">tweets_simple</span> <span class="k">AS</span>
<span class="k">SELECT</span>
  <span class="n">tweet_id</span><span class="p">,</span>
  <span class="k">cast</span> <span class="p">(</span> <span class="n">from_unixtime</span><span class="p">(</span> <span class="n">unix_timestamp</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span> <span class="s1">'2016 '</span><span class="p">,</span> <span class="k">substring</span><span class="p">(</span><span class="n">created_time</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">15</span><span class="p">)),</span> <span class="s1">'yyyy MMM dd hh:mm:ss'</span><span class="p">))</span> <span class="k">as</span> <span class="k">timestamp</span><span class="p">)</span> <span class="n">ts</span><span class="p">,</span>
  <span class="n">msg</span><span class="p">,</span>
  <span class="n">time_zone</span>
<span class="k">FROM</span> <span class="n">tweets_text</span><span class="p">;</span>
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/create_tweets_simple_view_sentiment_analysis.png" alt="create tweets simple view" /></p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">ADD</span> <span class="n">JAR</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">hdp</span><span class="o">/</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">1245</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">json</span><span class="o">-</span><span class="n">serde</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">8</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">-</span><span class="n">jar</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">dependencies</span><span class="p">.</span><span class="n">jar</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">tweets_clean</span> <span class="k">AS</span>
<span class="k">SELECT</span>
  <span class="n">t</span><span class="p">.</span><span class="n">tweet_id</span><span class="p">,</span>
  <span class="n">t</span><span class="p">.</span><span class="n">ts</span><span class="p">,</span>
  <span class="n">t</span><span class="p">.</span><span class="n">msg</span><span class="p">,</span>
  <span class="n">m</span><span class="p">.</span><span class="n">country</span>
 <span class="k">FROM</span> <span class="n">tweets_simple</span> <span class="n">t</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">time_zone_map</span> <span class="n">m</span> <span class="k">ON</span> <span class="n">t</span><span class="p">.</span><span class="n">time_zone</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">time_zone</span><span class="p">;</span>
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/add_jar.png" alt="add_jar" /></p>

<p>After running the above commands you should be able run <code class="highlighter-rouge">SELECT * FROM tweets_clean LIMIT 100;</code> which should yield results:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/view_tweets_clean_data_sentiment_analysis.png" alt="Data Table Folders" /></p>

<p>Now that we've cleaned our data we can get around to computing the sentiment. Use the following Hive commands to create some views that will allow us to do that.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="c1">-- Compute sentiment</span>
<span class="k">create</span> <span class="k">view</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">l1</span> <span class="k">as</span> <span class="k">select</span> <span class="n">tweet_id</span><span class="p">,</span> <span class="n">words</span> <span class="k">from</span> <span class="n">tweets_text</span> <span class="k">lateral</span> <span class="k">view</span> <span class="n">explode</span><span class="p">(</span><span class="n">sentences</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span> <span class="n">dummy</span> <span class="k">as</span> <span class="n">words</span><span class="p">;</span>

<span class="k">create</span> <span class="k">view</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">l2</span> <span class="k">as</span> <span class="k">select</span> <span class="n">tweet_id</span><span class="p">,</span> <span class="n">word</span> <span class="k">from</span> <span class="n">l1</span> <span class="k">lateral</span> <span class="k">view</span> <span class="n">explode</span><span class="p">(</span> <span class="n">words</span> <span class="p">)</span> <span class="n">dummy</span> <span class="k">as</span> <span class="n">word</span><span class="p">;</span>

<span class="k">create</span> <span class="k">view</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">l3</span> <span class="k">as</span> <span class="k">select</span>
    <span class="n">tweet_id</span><span class="p">,</span>
    <span class="n">l2</span><span class="p">.</span><span class="n">word</span><span class="p">,</span>
    <span class="k">case</span> <span class="n">d</span><span class="p">.</span><span class="n">polarity</span>
      <span class="k">when</span>  <span class="s1">'negative'</span> <span class="k">then</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">when</span> <span class="s1">'positive'</span> <span class="k">then</span> <span class="mi">1</span>
      <span class="k">else</span> <span class="mi">0</span> <span class="k">end</span> <span class="k">as</span> <span class="n">polarity</span>
 <span class="k">from</span> <span class="n">l2</span> <span class="k">left</span> <span class="k">outer</span> <span class="k">join</span> <span class="k">dictionary</span> <span class="n">d</span> <span class="k">on</span> <span class="n">l2</span><span class="p">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">word</span><span class="p">;</span>
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/compute_sentiment_sentiment_analysis.png" alt="compute sentiment" /></p>

<p>Now that we were able to compute some sentiment values we can assign whether a tweet was <strong>positive</strong>, <strong>neutral</strong>, or <strong>negative</strong>. Use this next Hive command to do that.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">tweets_sentiment</span> <span class="n">stored</span> <span class="k">as</span> <span class="n">orc</span> <span class="k">as</span> <span class="k">select</span>
  <span class="n">tweet_id</span><span class="p">,</span>
  <span class="k">case</span>
    <span class="k">when</span> <span class="k">sum</span><span class="p">(</span> <span class="n">polarity</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="s1">'positive'</span>
    <span class="k">when</span> <span class="k">sum</span><span class="p">(</span> <span class="n">polarity</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="s1">'negative'</span>  
    <span class="k">else</span> <span class="s1">'neutral'</span> <span class="k">end</span> <span class="k">as</span> <span class="n">sentiment</span>
<span class="k">from</span> <span class="n">l3</span> <span class="k">group</span> <span class="k">by</span> <span class="n">tweet_id</span><span class="p">;</span>
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/compute_sentiment_values_sentiment_analysis.png" alt="compute sentiment values" /></p>

<p>Lastly, to make our analysis somewhat easier we are going to turn those 'positive', 'negative', and 'neutral' values into numerical values using the next Hive command</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">tweetsbi</span>
<span class="n">STORED</span> <span class="k">AS</span> <span class="n">ORC</span>
<span class="k">AS</span> <span class="k">SELECT</span>
  <span class="n">t</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
  <span class="k">case</span> <span class="n">s</span><span class="p">.</span><span class="n">sentiment</span>
    <span class="k">when</span> <span class="s1">'positive'</span> <span class="k">then</span> <span class="mi">2</span>
    <span class="k">when</span> <span class="s1">'neutral'</span> <span class="k">then</span> <span class="mi">1</span>
    <span class="k">when</span> <span class="s1">'negative'</span> <span class="k">then</span> <span class="mi">0</span>
  <span class="k">end</span> <span class="k">as</span> <span class="n">sentiment</span>  
<span class="k">FROM</span> <span class="n">tweets_clean</span> <span class="n">t</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">tweets_sentiment</span> <span class="n">s</span> <span class="k">on</span> <span class="n">t</span><span class="p">.</span><span class="n">tweet_id</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">tweet_id</span><span class="p">;</span>
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/transform_values_numerically_sentiment_analysis.png" alt="Hive Sentiment Analysis Results" /></p>

<p>This command should yield our final results table as shown below.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/view_tweetsbi_data_sentiment_analysis.png" alt="Hive Sentiment Analysis Results" /></p>

<p><strong>Try the new Hive Visualization tab!</strong></p>

<p>On the right hand side of the screen try clicking the <strong>graph icon</strong> in the column located in row 3. It will bring up a new tab where you can directly create charts using your query results in Hive!</p>

<p>Now that we can access the sentiment data in our Hive table let's do some visualization on the analysis using Apache Zeppelin.</p>

<h2 id="visualize-sentiment-with-zeppelin-">Visualize Sentiment With Zeppelin <a id="visualizing-sentiment-with-zeppelin"></a></h2>
<hr />

<p>Make sure your Zeppelin service is started in Ambari, then head over to the Zeppelin at <a href="http://sandbox.hortonworks.com:9995/">http://sandbox.hortonworks.com:9995</a>.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/zeppelin_welcome_screen_sentiment_analysis.png" alt="Hive Sentiment Analysis Results" /></p>

<p>Use the <strong>Notebook</strong> dropdown menu at the top of the screen and click <strong>+ Create New Note</strong>. After which, you can name the note <strong>Sentiment Analysis</strong>.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/36_zeppelin_create_note.png" alt="Hive Sentiment Analysis Results" /></p>

<p>After creating the note, open it up to the blank Notebook screen and type the following command.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="o">%</span><span class="n">hive</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tweetsbi</span> <span class="k">LIMIT</span> <span class="mi">300</span>
</code></pre>
</div>

<p>We're limiting our query to just <code class="highlighter-rouge">300</code> results because right now we won't need to see everything. And if you've collected a lot of data from NiFi, then it could slow down your computer.</p>

<ul>
  <li>Arrange your results so that your chart is a <strong>bar graph</strong>.</li>
  <li>The <code class="highlighter-rouge">tweetsbi.country</code> column is a <strong>key</strong> and the <code class="highlighter-rouge">tweetsbi.sentiment</code> as the <strong>value</strong>.</li>
  <li>Make sure that <strong>sentiment</strong> is labeled as <strong>COUNT</strong>.</li>
  <li>Run the query by <strong>clicking the arrow on the right hand side</strong>, or by pressing <strong>Shift+Enter</strong>.</li>
</ul>

<p>Your results should look like the following:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/tweetsbi_bar_graph_sentiment_analysis.png" alt="First Zeppelin Query Results" /></p>

<p>After looking at the results we see that if we group by country that many tweets are actually labeled as null.</p>

<p>For the sake of visualization let's remove any tweets that might appear in our select statement that have a country value of "null", as well as increase our result limit to 500.</p>

<p>Scroll down to the next note and create run the following query, and set up the results the same way as above.</p>

<blockquote>
  <p><strong>Note</strong> Before running Hive queries, restart the Spark Interpreter since Spark jobs take up cluster resources. Click the <strong>Interpreter</strong> tab located near Zeppelin logo at the top of the page, under <strong>Spark</strong> click on the button that says <strong>restart</strong>.</p>
</blockquote>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="o">%</span><span class="n">hive</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">tweetsbi</span> <span class="k">where</span> <span class="n">country</span> <span class="o">!=</span> <span class="nv">"null"</span> <span class="k">LIMIT</span> <span class="mi">500</span>
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/eliminate_null_bargraph_sentiment_analysis.png" alt="Non Null Countries in Results" /></p>

<p>Great! Now given the data we have, we can at least have an idea of the distribution of users who's tweets come from certain countries!</p>

<p>You can also experiment with this and try a pie chart as well.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/39_zeppelin_country_pie_chart.png" alt="Pie chart of above results" /></p>

<p>In our original raw tweet data from NiFi we also collected the language from our users as well. So we can also get an idea of the distribution of languages!</p>

<p>Run the following query and make</p>

<ul>
  <li><strong>lang</strong> as the <strong>Key</strong></li>
  <li><strong>COUNT</strong> for <strong>lang</strong> in <strong>values</strong></li>
</ul>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="o">%</span><span class="n">hive</span>
<span class="k">select</span> <span class="n">lang</span><span class="p">,</span> <span class="n">time_zone</span> <span class="k">from</span> <span class="n">tweets_text</span> <span class="k">LIMIT</span> <span class="mi">1000</span>
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/40_zeppelin_language_pie_chart.png" alt="Pie chart of language results" /></p>

<p>If you have not seen from our earlier analysis in Hive</p>

<ul>
  <li>A bad or negative sentiment is <strong>0</strong></li>
  <li>A neutral sentiment value is <strong>1</strong>.</li>
  <li>A positive sentiment value is <strong>2</strong>.</li>
</ul>

<p>Using this we can now look at individual countries and see the sentiment distributions of each.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="o">%</span><span class="n">hive</span>
<span class="k">select</span> <span class="n">sentiment</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">country</span><span class="p">),</span> <span class="n">country</span> <span class="k">from</span> <span class="n">tweetsbi</span> <span class="k">group</span> <span class="k">by</span> <span class="n">sentiment</span><span class="p">,</span> <span class="n">country</span> <span class="k">having</span> <span class="n">country</span> <span class="o">!=</span> <span class="nv">"null"</span>
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp-2.5/assets/nifi-sentiment-analytics/images/41_zeppelin_sentiment_average.png" alt="Sentiment Comparison" /></p>

<p>Using this data you can determine how you might want to market your products to different countries!</p>

<h2 id="further-reading">Further Reading</h2>

<ul>
  <li><a href="http://hortonworks.com/blog/category/nifi/">NiFi blogs</a></li>
  <li><a href="http://hortonworks.com/hadoop-tutorial/searching-data-solr/">Indexing and Searching Documents with Apache Solr</a></li>
  <li><a href="http://hortonworks.com/blog/introduction-to-data-science-with-apache-spark/">Introduction to Data Science with Apache Zeppelin</a></li>
  <li><a href="http://hortonworks.com/community/">Hortonworks Community Connection</a></li>
  <li><a href="https://community.hortonworks.com/spaces/81/index.html">HDP Sandbox &amp; Learning Forum</a></li>
</ul>

</div>

<div id="tutorial-footer">
  <hr>
  <h2>Tutorial Q&amp;A and Reporting Issues</h2>
  <p>If you need help or have questions with this tutorial, please first check HCC for existing Answers to questions on this tutorial using the Find Answers button.  If you don't find your answer you can post a new HCC question for this tutorial using the Ask Questions button.</p>
  <p><a class="btn" href="https://community.hortonworks.com/topics/tutorial-210.html" role="button">Find Answers</a> <a class="btn pull-right" href="https://community.hortonworks.com/questions/ask.html?space=81&topics=tutorial-210&topics=hdp-2.5.0" role="button">Ask Questions</a></p>
  <p>Tutorial Name: <strong>How to Refine and Visualize Social Media Sentiment Data</strong></p>
  <p>HCC Tutorial Tag:<strong> tutorial-210</strong> and <strong>hdp-2.5.0</strong></p>
  <p>If the tutorial has multiple labs please indicate which lab your question corresponds to. Please provide any feedback related to that lab.</p>
  <p>All Hortonworks, partner and community tutorials are posted in the Hortonworks github and can be contributed via the <a href="https://github.com/hortonworks/tutorials/wiki">Hortonworks Tutorial Contribution Guide</a>.  If you are certain there is an issue or bug with the tutorial, please <a href="https://github.com/hortonworks/tutorials/wiki#issues-with-tutorials">create an issue</a> on the repository and we will do our best to resolve it!</p>
</div>
