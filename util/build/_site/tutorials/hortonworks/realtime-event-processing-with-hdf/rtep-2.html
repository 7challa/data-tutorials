

<div class="tutorial-content">
  <h1 id="lab-1-capture-real-time-event-stream-with-apache-kafka">Lab 1: Capture Real Time Event Stream with Apache Kafka</h1>

<h2 id="introduction">Introduction</h2>

<p><a href="http://kafka.apache.org/">Apache Kafka</a> can be used on the Hortonworks Data Platform to capture real-time events. We will begin with showing you how to configure Apache Kafka and Zookeeper. Next we will show you how to capture truck event data from Apache NiFi using Kafka.</p>

<h2 id="pre-requisites">Pre-Requisites</h2>
<ul>
  <li>Lab 0 Ingest, Route and Land Real Time Events with Apache NiFi</li>
  <li>Downloaded and Installed latest <a href="http://hortonworks.com/products/hortonworks-sandbox/#install">Hortonworks Sandbox</a></li>
  <li>You will need admin privileges for this tutorial, refer to <a href="http://hortonworks.com/hadoop-tutorial/learning-the-ropes-of-the-hortonworks-sandbox/">Learning the Ropes of the Hortonworks Sandbox</a> to setup your Ambari admin password</li>
  <li>Memory must be at least 8GB RAM, preferably 4 processor cores, else errors may occur in third tutorial</li>
</ul>

<h2 id="outline">Outline</h2>

<ul>
  <li><a href="#apache-kafka-lab1">Apache Kafka</a></li>
  <li><a href="#navigate-ambari-user-views-lab1">Step 1: Navigate to Ambari User Views</a></li>
  <li><a href="#start-kafka-lab1">Step 2: Start Apache Kafka</a></li>
  <li><a href="#configure-kafka-with-zookeeper-lab1">Step 3: Configure Kafka with Zookeeper</a></li>
  <li><a href="#define-kafka-topic-lab1">Step 4: Create Kafka Topic</a></li>
  <li><a href="#create-nifi-putkafka-lab1">Step 5: Create NiFi PutKafka Processor</a></li>
  <li><a href="#summary-lab1">Summary</a></li>
  <li><a href="#install-kafka-lab1">Appendix A: Install Kafka</a></li>
  <li><a href="#further-reading-lab1">Further Reading</a></li>
</ul>

<h2 id="apache-kafka-a-idapache-kafka-lab1a">Apache Kafka <a id="apache-kafka-lab1"></a></h2>

<p><a href="http://kafka.apache.org/">Apache Kafka</a> is an open source messaging system designed for:</p>

<ul>
  <li>Persistent messaging</li>
  <li>High throughput</li>
  <li>Distributed</li>
  <li>Multi-client support</li>
  <li>Real time</li>
</ul>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/Kafka-Broker-Diagram.png" alt="Kafka Producer-Broker-Consumer" /></p>

<p>Kafka Producer-Broker-Consumer</p>

<h2 id="tutorial-overview">Tutorial Overview</h2>

<ol>
  <li>Install and Start Kafka on latest <a href="http://hortonworks.com/products/hortonworks-sandbox/">Hortonworks Sandbox</a>.</li>
  <li>Review Kafka and ZooKeeper Configs</li>
  <li>Create Kafka topics for Truck events.</li>
  <li>Write Kafka Producers for Truck events.</li>
</ol>

<h3 id="step-1-navigate-to-ambari-a-idnavigate-ambari-user-views-lab1a">Step 1: Navigate to Ambari <a id="navigate-ambari-user-views-lab1"></a></h3>

<h3 id="start-the-hortonworks-sandbox">1.1 Start the Hortonworks Sandbox</h3>

<p>After downloading the Sandbox and running the VM, login to the Sandbox using the URL displayed in the console. For example, the URL in the screenshot below is <code class="highlighter-rouge">http://127.0.0.1:8888/</code></p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/sandbox_vm_welcome_screen.png" alt="sandbox_vm_welcome_screen" /></p>

<h3 id="login-to-ambari">1.2 Login to Ambari</h3>

<p>After resetting your Ambari admin password with assistance from <a href="http://hortonworks.com/hadoop-tutorial/learning-the-ropes-of-the-hortonworks-sandbox/">Learning the Ropes of the Hortonworks Sandbox</a>, Go to port 8080 of your Sandbox's IP address to view the Ambari login page. For example, <code class="highlighter-rouge">http://127.0.0.1:8080:</code></p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/login_page_ambari.png" alt="" /></p>

<h3 id="step-2-start-apache-kafka-a-idstart-kafka-lab1a">Step 2: Start Apache Kafka <a id="start-kafka-lab1"></a></h3>

<h3 id="view-the-kafka-services-page">2.1  View the Kafka Services page</h3>

<p>From the Dashboard page of Ambari, click on Kafka from the list of installed services. (If Kafka is not installed, perform the steps in <a href="#appendix-a">Appendix A</a> first.):</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/kafka_service_on_off.png" alt="" /></p>

<h3 id="enable-kafka">2.2 Enable Kafka</h3>

<p>From the Kafka page, click on Service Actions -&gt; Start:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/start_kafka_service_iot.png" alt="" /></p>

<p>Check the box and click on Confirm Start:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/confirmation_kafka_service_start.png" alt="Screen Shot 2015-06-04 at 3.06.10 PM.png" /></p>

<p>Wait for Kafka to start.</p>

<h3 id="step-3-configure-kafka-with-zookeeper-a-idconfigure-kafka-with-zookeeper-lab1a">Step 3: Configure Kafka with ZooKeeper <a id="configure-kafka-with-zookeeper-lab1"></a></h3>

<p>ZooKeeper serves as the coordination interface between the Kafka broker and consumers:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/zookeeper-kafka-producer-broker-consumer.jpg" alt="Single Broker based Kakfa cluster" /></p>

<p>The important Zookeeper properties can be checked in Ambari.</p>

<h3 id="configure-zookeeper">3.1  Configure ZooKeeper</h3>

<p>Click on <strong>ZooKeeper</strong> in the list of services, then click on the Configs tab. Verify ZooKeeper is running on port 2181:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/zookeeper_port_config.png" alt="" /></p>

<p>If this port 2181 is busy or is consumed by other processes, then you could change the default port number of ZooKeeper to any other valid port number. If ZooKeeper is not running, you can start the Zookeeper service from Ambari:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/zookeeper_start_service_iot.png" alt="" /></p>

<h3 id="configure-kafka">3.2 Configure Kafka</h3>

<p>From the Kafka page, click on the <strong>Configs</strong> tab. Verify the <code class="highlighter-rouge">zookeeper.connect</code> property points to your ZooKeeper server name and port:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/verify_zookeeper_connect_pts_zoo_server_kafka.png" alt="" /></p>

<h3 id="step-4-define-a-kafka-topic-a-iddefine-kafka-topic-lab1a">Step 4: Define a Kafka Topic <a id="define-kafka-topic-lab1"></a></h3>

<h3 id="ssh-into-the-sandbox">4.1 SSH into the Sandbox</h3>

<p>SSH into the Sandbox to define the Kafka topic. Type the following command:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>ssh root@127.0.0.1 -p 2222
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/ssh_into_sandbox_shell_kafka_iot.png" alt="ssh_into_sandbox_shell_kafka_iot" /></p>

<blockquote>
  <p>NOTE: You can also SSH using a program like Putty for Windows or the Terminal application on a Mac.</p>
</blockquote>

<h3 id="create-a-new-topic">4.2 Create a new Topic</h3>

<p>Use the <code class="highlighter-rouge">kafka-topics.sh</code> script (which should be in your PATH), create a new topic named <code class="highlighter-rouge">truck_events</code>:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="o">[</span>root@sandbox ~]# kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 2 --topic truck_events
</code></pre>
</div>

<p>If the <code class="highlighter-rouge">kafka-topics.sh</code> script is not in your PATH and you get a command not found error, then change directories to where the Kafka scripts are installed:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="o">[</span>root@sandbox ~]# <span class="nb">cd</span> /usr/hdp/current/kafka-broker/bin/
</code></pre>
</div>

<p>You will need to <strong>add a dot and a slash (./)</strong> to the beginning of the commands:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="o">[</span>root@sandbox bin]# ./kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 2 --topic truck_events
</code></pre>
</div>

<p>Also note that sometimes ZooKeeper does not listen on <code class="highlighter-rouge">localhost</code>, so you may need to use the Sandbox's IP address instead.</p>

<p>The output should show your topic was created:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/created_kafka_topic_iot.png" alt="created_kafka_topic_iot" /></p>

<h3 id="verify-the-topic-was-created-successfully">4.3 Verify the topic was created successfully</h3>

<p>Check if topic <code class="highlighter-rouge">truck_events</code> was created successfully with the following command:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="o">[</span>root@sandbox ~]# ./kafka-topics.sh --list --zookeeper localhost:2181
</code></pre>
</div>

<p>You should see <code class="highlighter-rouge">truck_events</code> in the list of topics (and probably your only topic):</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/verify_kafka_topic_created_iot.png" alt="" /></p>

<h3 id="step-5-create-nifi-putkafka-processor-a-idcreate-nifi-putkafka-lab1a">Step 5: Create NiFi PutKafka Processor <a id="create-nifi-putkafka-lab1"></a></h3>

<p>In the previous tutorial, we stored the truck event data into a file. Now we can use the <a href="https://nifi.apache.org/docs/nifi-docs/components/org.apache.nifi.processors.kafka.PutKafka/index.html">PutKafka</a> processor since the Kafka service is running, we have access to the "Known Broker", "Topic Name" and "Client Name." We will send the truck event contents of a FlowFile to Kafka as a message. Similar to the Kafka Producer, NiFi acts as a producer since it creates messages and publishes them to the Kafka broker for further consumption.</p>

<p>1. If not already open, navigate to the NiFi Web Interface at <code class="highlighter-rouge">http://127.0.0.1:6434/nifi/</code>. For vmware and azure, the host and port may be different.</p>

<p>2. If your data flow is still running, click on the stop button <img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab0-nifi/stop_symbol_nifi_iot.png" alt="stop_symbol_nifi_iot" /> in the <strong>actions</strong> toolbar to stop the flow.</p>

<h3 id="add-putkafka-processor">5.1 Add PutKafka Processor</h3>

<p>1. Drag the processor icon onto your graph. Add the <strong>PutKafka</strong> processor.</p>

<p>2. Right click on the Putkafka processor, click on <strong>configure</strong>.</p>

<p>3. The warning message tells us, we need to add "Known Broker", "Topic Name" and "Client Name" values to our Properties section. Enter the following information into the <strong>Properties</strong> section in the <strong>Configure Processor</strong> window:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Property = Value
Known Brokers = sandbox.hortonworks.com:6667
Topic Name = truck_events
Message Delimiter = press "Shift+enter"
Client Name = truck_events_client
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/putkafka_processor_config_nifi_iot.png" alt="putkafka_processor_config_nifi_iot" /></p>

<blockquote>
  <p>Note: Every property above is required except <strong>Message Delimiter</strong>, but this property is helpful with splitting apart the contents of the FlowFile.</p>
</blockquote>

<p><strong>Known Brokers</strong> can be found in <strong>Kafka</strong> configs under listeners</p>

<p><strong>Topic Name</strong> is the name you created earlier for Kafka. Type the following command to see your topic name: ./kafka-topics.sh –list –zookeeper localhost:2181.</p>

<p><strong>Message Delimiter</strong> set as "Shift+enter" in the value field makes each line of incoming FlowFile a single message, so kafka does not receive an enormous flowfile as a single message.</p>

<p><strong>Client Name</strong> can be named to your liking, it is the name that is used when communicating with kafka.</p>

<p>4. Open the Configure Processor window again, navigate to the <strong>Settings</strong> tab. Set the <strong>Auto termination relationship</strong> to <code class="highlighter-rouge">success</code> and <code class="highlighter-rouge">failure</code>. Click <strong>apply</strong>.</p>

<p>5. Connect the <strong>MergeContent(truck_events)</strong> processor to <strong>PutKafka</strong>. A Create Connection window will appear, set the <strong>For relationship</strong> to <code class="highlighter-rouge">merged</code>.</p>

<p>You should obtain a similar dataflow as the following:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/dataflow_final_withkafka_iot.png" alt="dataflow_final_withkafka_iot" /></p>

<blockquote>
  <p>Note: If there is a warning symbol after updating the PutKafka, verify that the property values are correct. Check <strong>3</strong>. in case you need to review the values changed.</p>
</blockquote>

<p>6. Let's start our Hortonworks DataFlow to see a real live stream of truck event data be read from NiFi and written to a Kafka cluster. In the <strong>actions</strong> toolbar, hit the <strong>start</strong> button.</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/dataflow_withKafka_running_iot.png" alt="dataflow_withKafka_running_iot" /></p>

<blockquote>
  <p>Dataflow generates data, filtering truck events from the dataflow and sending those events to kafka.</p>
</blockquote>

<h3 id="verify-putkafka-published-message-to-kafka">5.2 Verify PutKafka Published Message to Kafka</h3>

<p>After a few seconds, stop the NiFi DataFlow using the <strong>stop</strong> button in the <strong>actions</strong> toolbar.
To verify that the PutKafka processor successfully published messages to the Kafka cluster, execute the following command to start a consumer to see the produced events:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="o">[</span>root@sandbox ~]# <span class="nb">cd</span> /usr/hdp/current/kafka-broker/bin/
<span class="o">[</span>root@sandbox bin]# ./kafka-console-consumer.sh --zookeeper sandbox.hortonworks.com:2181 --topic truck_events --from-beginning
</code></pre>
</div>

<p>Your terminal should show that messages successfully published to Kafka:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/messages_published_toKafka.png" alt="messages_published_toKafka" /></p>

<h2 id="summary-a-idsummary-lab1a">Summary <a id="summary-lab1"></a></h2>

<p>This tutorial gave you brief glimpse of how to use Apache Kafka to capture real-time event data as a message and verify that Kafka successfully received those messages. In our next tutorial, you will create HBase and Hive tables to ingest real-time streaming data using Storm.</p>

<h2 id="appendix-a-install-kafka-a-idinstall-kafka-lab1a">Appendix A: Install Kafka <a id="install-kafka-lab1"></a></h2>

<p>Follow these steps if your version of the Sandbox does not have Kafka installed:</p>

<p>1.  From the Ambari Dashboard, select Actions -&gt; Add Service:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/add_service_kafka.png" alt="" /></p>

<p>2.  Select Kafka from the list of Services and click Next:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/addServiceWizard_kafka_service_iot.png" alt="" /></p>

<p>3.  Keep clicking Next with the selected defaults until you reach the following screen:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/log_dirs_kafka_broker_iot.png" alt="" /></p>

<p>4.  Set the value of logs.dir to  /tmp/kafka-logs</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/change_kafka_broker_log_dirs_iot.png" alt="" /></p>

<p>5.  Click the Deploy button:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/deploy_kafka_service_iot.png" alt="" /></p>

<p>6.  Wait for Kafka to install:</p>

<p><img src="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/realtime-event-processing-with-hdf/lab1-kafka/wait_kafka_service_install_iot.png" alt="" /></p>

<p>7.  After Kafka is installed, you may be asked to restart some dependent Services. Please select the appropriate Services and click Restart.</p>

<h2 id="further-reading-a-idfurther-reading-lab1a">Further Reading <a id="further-reading-lab1"></a></h2>
<ul>
  <li><a href="http://kafka.apache.org/">Apache Kafka Documentation</a></li>
  <li><a href="http://hortonworks.com/hadoop/kafka/">Kafka Overview</a></li>
  <li><a href="https://zookeeper.apache.org/">Apache Zookeeper Documentation</a></li>
</ul>

</div>

<div id="tutorial-footer">
  <hr>
  <h2>Tutorial Q&amp;A and Reporting Issues</h2>
  <p>If you need help or have questions with this tutorial, please first check HCC for existing Answers to questions on this tutorial using the Find Answers button.  If you don't find your answer you can post a new HCC question for this tutorial using the Ask Questions button.</p>
  <p><a class="btn" href="https://community.hortonworks.com/topics/tutorial-220.html" role="button">Find Answers</a> <a class="btn pull-right" href="https://community.hortonworks.com/questions/ask.html?space=81&topics=tutorial-220&topics=hdp-2.4.0" role="button">Ask Questions</a></p>
  <p>Tutorial Name: <strong>Capture Real Time Event Stream with Apache Kafka</strong></p>
  <p>HCC Tutorial Tag:<strong> tutorial-220</strong> and <strong>hdp-2.4.0</strong></p>
  <p>If the tutorial has multiple labs please indicate which lab your question corresponds to. Please provide any feedback related to that lab.</p>
  <p>All Hortonworks, partner and community tutorials are posted in the Hortonworks github and can be contributed via the <a href="https://github.com/hortonworks/tutorials/wiki">Hortonworks Tutorial Contribution Guide</a>.  If you are certain there is an issue or bug with the tutorial, please <a href="https://github.com/hortonworks/tutorials/wiki#issues-with-tutorials">create an issue</a> on the repository and we will do our best to resolve it!</p>
</div>
