

<div class="tutorial-content">
  <h2 id="lab-1-securing-hdfs-hive-hbase-data-using-apache-ranger">Lab 1: Securing HDFS, Hive, HBase Data using Apache Ranger</h2>

<h2 id="introduction">Introduction</h2>

<p>In this tutorial we will explore how you can use policies in Apache Ranger to protect your enterprise data lake and audit access by users to resources on HDFS, Hive and HBase from a centralized Ranger Administration Console.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>Download <a href="http://hortonworks.com/products/hortonworks-sandbox/#install">Hortonworks Sandbox</a></li>
  <li>Complete the <a href="http://hortonworks.com/hadoop-tutorial/learning-the-ropes-of-the-hortonworks-sandbox/">Learning the Ropes of the HDP Sandbox</a> tutorial.</li>
</ul>

<h2 id="outline">Outline</h2>

<ul>
  <li><a href="#start-hbase-infra">1: Start HBase and Ambari Infra Services</a></li>
  <li><a href="#login-ranger">2: Login to Ranger Administration Console</a></li>
  <li><a href="#review-hdfs-policies">3: Review Existing HDFS Policies</a></li>
  <li><a href="#exercise-hdfs-access">4: Exercise HDFS Access Scenarios</a></li>
  <li><a href="#review-hive-policies">5: Review Hive Policies</a></li>
  <li><a href="#exercise-hive-access">6: Exercise Hive Access Scenarios</a></li>
  <li><a href="#review-hbase-policies">7: Review HBase Policies</a></li>
  <li><a href="#exercise-hbase-access">8: Exercise HBase Access Scenarios</a></li>
  <li><a href="#summary">9: Summary</a></li>
</ul>

<h3 id="1-start-hbase-and-ambari-infra-services-">1: Start HBase and Ambari Infra Services <a id="start-hbase-infra"></a></h3>

<p>Go to Ambari and login  with user credentials <strong>raj_ops/raj_ops</strong>. If HBase is switched off go to <code class="highlighter-rouge">Service Actions</code> button on top right and <code class="highlighter-rouge">Start</code> the service</p>

<p><img src="/assets/securing-data-lake-with-ranger/start_hbase.png" alt="start_hbase" /></p>

<p>Check the box for <strong>Maintenance Mode</strong>.</p>

<p><img src="/assets/securing-data-lake-with-ranger/hbase_maintenance_mode.png" alt="hbase_maintenance_mode" /></p>

<p>Next, click <code class="highlighter-rouge">Confirm Start</code>. Wait for 30 seconds and your HBase will start running.
Similarly, start <strong>Ambari Infra</strong> to record all the audits through Ranger. Your <strong>Ambari dashboard</strong> should look like this:</p>

<p><img src="/assets/securing-data-lake-with-ranger/ambari_dashboard_rajops_infra.png" alt="ambari_dashboard_rajops_infra" /></p>

<h3 id="2-login-to-ranger-administration-console-">2: Login to Ranger Administration Console <a id="login_ranger"></a></h3>

<p>Once the VM is running in VirtualBox, login to the Ranger Administration console at <strong>http://localhost:6080/</strong> from your host machine. The username is <strong>raj_ops</strong> and the password is <strong>raj_ops</strong>.</p>

<p><img src="/assets/securing-data-lake-with-ranger/ranger_login_rajops.png" alt="ranger_login_rajops" /></p>

<p>As soon as you login, you should see list of repositories as shown below:</p>

<p><img src="/assets/securing-data-lake-with-ranger/list_repositories.png" alt="list_repositories" /></p>

<h3 id="3-review-existing-hdfs-policies-">3: Review Existing HDFS Policies <a id="review-hdfs-policies"></a></h3>

<p>Please click on <code class="highlighter-rouge">Sandbox_hadoop</code> link under HDFS section</p>

<p><img src="/assets/securing-data-lake-with-ranger/sandbox_hadoop_policies.png" alt="sandbox_hadoop_policies" /></p>

<p>User can review policy details by a single click on the box right to the policy. Click on the <code class="highlighter-rouge">HDFS Global Allow policy</code>. Click the slider so it is in <strong>disable</strong> position.</p>

<p><img src="/assets/securing-data-lake-with-ranger/click_hdfs_global_allow_disable.png" alt="click_hdfs_global_allow_disable" /></p>

<p>Then click <code class="highlighter-rouge">Save</code>.</p>

<h3 id="4-exercise-hdfs-access-scenarios-">4. Exercise HDFS Access Scenarios <a id="exercise-hdfs-access"></a></h3>

<p>Login to the Ambari by the following credentials:</p>

<p>Username - <strong>raj_ops</strong>
Password - <strong>raj_ops</strong></p>

<p>Click on 9 square menu icon and select <code class="highlighter-rouge">Files view:</code></p>

<p><img src="/assets/securing-data-lake-with-ranger/select_files_view.png" alt="select_files_view" /></p>

<p>You will see a home page like the one given below. Click on <code class="highlighter-rouge">demo</code> folder</p>

<p><img src="/assets/securing-data-lake-with-ranger/files_view_home_page.png" alt="files_view_home_page" /></p>

<p>Next, click on <code class="highlighter-rouge">data</code>. You will see a message like this:</p>

<p><img src="/assets/securing-data-lake-with-ranger/demo_data_error.png" alt="demo_data_error" /></p>

<p>Click on <code class="highlighter-rouge">details</code>, that will lead you to the page that shows the permission denied for the user <strong>raj_ops</strong>:</p>

<p><img src="/assets/securing-data-lake-with-ranger/demo_data_message.png" alt="demo_data_message" /></p>

<p>Go back to Ranger and then to the <code class="highlighter-rouge">Audits Tab</code> and check that its event (denied) being audited. You can filter by searching <strong>Result as Denied</strong></p>

<p><img src="/assets/securing-data-lake-with-ranger/audit_results_hdfs.png" alt="audit_results_hdfs" /></p>

<p>Now, go back to the <strong>HDFS Global Allow Policy</strong>. Click the switch to enable it and try running the command again</p>

<p><img src="/assets/securing-data-lake-with-ranger/click_hdfs_global_allow_enable.png" alt="click_hdfs_global_allow_enable" /></p>

<p>Click <code class="highlighter-rouge">Save</code>.<br />
Now let us go back to Files view and Navigate back to <code class="highlighter-rouge">/demo/data/</code>. You will see three folders under data due to enabled HDFS global policy.</p>

<p>Now head back to the Audit tab in Ranger and search by <code class="highlighter-rouge">User: raj_ops</code>. Here you can see that the request was allowed through</p>

<p><img src="/assets/securing-data-lake-with-ranger/audit_result_hdfs_allowed.png" alt="audit_result_hdfs_allowed" /></p>

<h3 id="5-review-hive-policies-">5. Review Hive Policies <a id="review-hive-policies"></a></h3>

<p>Click on <code class="highlighter-rouge">Access Manager=&gt;Resource Based Policies</code> section on the top menu, then click on <code class="highlighter-rouge">Sandbox_hive</code> link under HIVE section to view list of Hive Policies:</p>

<p><img src="/assets/securing-data-lake-with-ranger/sandbox_hive_policies.png" alt="sandbox_hive_policies" /></p>

<p>User can review policy details by a single click on the box right to the policy.<br />
Disable the <strong>Hive Global Tables Allow Policy</strong> :</p>

<p><img src="/assets/securing-data-lake-with-ranger/click_hive_global_allow_disable.png" alt="click_hive_global_allow_disable" /></p>

<p>Also disable the <code class="highlighter-rouge">policy for raj_ops, holger_gov, maria_dev and amy_ds</code>.<br />
You should see a page like this:</p>

<p><img src="/assets/securing-data-lake-with-ranger/sandbox_hive_policies_disabled.png" alt="sandbox_hive_policies_disabled" /></p>

<h3 id="6-exercise-hive-access-scenarios-">6. Exercise Hive Access Scenarios <a id="exercise-hive-access"></a></h3>

<p>Go back to Ambari and click on 9 square menu icon and select <code class="highlighter-rouge">Hive view</code>:</p>

<p><img src="/assets/securing-data-lake-with-ranger/select_hive_view.png" alt="select_hive_view" /></p>

<p>Run the following query:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>select * from foodmart.product;
</code></pre>
</div>

<p>You will come across error message which states that <strong>Permission denied for raj_ops because it does not have a SELECT privilege</strong>.</p>

<p><img src="/assets/securing-data-lake-with-ranger/foodmart_product_message.png" alt="foodmart_product_message" /></p>

<p>Next, go back to Ranger and then Audits and see its access (denied) being audited. You can do this the same way that we checked for the raj_ops user. Just search the audit log by user to see.</p>

<p><img src="/assets/securing-data-lake-with-ranger/audit_results_hive.png" alt="audit_results_hive" /></p>

<p>Re-Enable the <strong>Global Hive Tables Allow</strong> policy and <strong>Policy for raj_ops, holger_gov, maria_dev and amy_ds</strong>.<br />
Go back to <strong>Hive View</strong> and run the same query again:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>select * from foodmart.product;
</code></pre>
</div>

<p><img src="/assets/securing-data-lake-with-ranger/foodmart_product_successful.png" alt="foodmart_product_successful" /></p>

<p>This time, the query runs successfully and you can see all data in product table. Go back to Ranger and then Audits to see its access (granted) being audited.</p>

<p><img src="/assets/securing-data-lake-with-ranger/audit_results_hive_allowed.png" alt="audit_results_hive_allowed" /></p>

<h3 id="7-review-hbase-policies-">7. Review HBase Policies <a id="review-hbase-policies"></a></h3>

<p>Click on <code class="highlighter-rouge">Access Manager=&gt;Resource Based Policies</code> section on the top menu, then click on the <code class="highlighter-rouge">Sandbox_hbase</code> to view list of hbase Policies.</p>

<p><img src="/assets/securing-data-lake-with-ranger/sandbox_hbase_policies.png" alt="sandbox_hbase_policies" /></p>

<p>User can review policy details by a single click on the box right to the policy. Disable the <strong>HBase Global Allow Policy</strong> in the same manner that we did before.</p>

<h3 id="8-exercise-hbase-access-scenarios-">8. Exercise HBase Access Scenarios <a id="exercise-hbase-access"></a></h3>

<p>First you’re going to need to log in to your Sandbox via SSH. If you’re using Virtualbox you can log in with the command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ssh root@127.0.0.1 -p 2222
</code></pre>
</div>

<p>The first time password to log in is: <strong>hadoop</strong></p>

<p><img src="/assets/securing-data-lake-with-ranger/sshTerminal.png" alt="sshTerminal" /></p>

<p>Login into HBase shell as <strong>raj_ops</strong> user:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>su raj_ops
hbase shell
</code></pre>
</div>

<p><img src="/assets/securing-data-lake-with-ranger/hbase_shell_rajops.png" alt="hbase_shell_rajops" /></p>

<p>Run the hbase shell command to validate access for raj_ops user-id, to see if he can view table data from the iemployee table:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>get 'iemployee', '1'
</code></pre>
</div>

<p>Then you should get an Access Denied Exception like:</p>

<p><img src="/assets/securing-data-lake-with-ranger/iemployee_message.png" alt="iemployee_message" /></p>

<p>Let us check the audit log in Ranger too:</p>

<p><img src="/assets/securing-data-lake-with-ranger/audit_results_hbase.png" alt="audit_results_hbase" /></p>

<p>Next, enable the <strong>HBase Global Allow Policy</strong>.<br />
After making a change in the policy, go back to HBase shell and run the same query again:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>get 'iemployee','1'
</code></pre>
</div>

<p><img src="/assets/securing-data-lake-with-ranger/iemployee_successful.png" alt="iemployee_successful" /></p>

<p>Now, you can view all the data in <strong>iemployee</strong> table under <strong>rowkey 1</strong>. Go to Ranger to check audit logs:</p>

<p><img src="/assets/securing-data-lake-with-ranger/audit%20_results_hbase_allowed.png" alt="audit_results_hbase_allowed" /></p>

<h3 id="9-summary-">9. Summary <a id="summary"></a></h3>

<p>Hopefully by following this tutorial, you got a taste of the power and ease of securing your key enterprise resources using Apache Ranger.</p>

<p><strong>Happy Hadooping!!!</strong></p>

</div>

<div id="tutorial-footer">
  <hr>
  <h2>Tutorial Q&amp;A and Reporting Issues</h2>
  <p>If you need help or have questions with this tutorial, please first check HCC for existing Answers to questions on this tutorial using the Find Answers button.  If you don't find your answer you can post a new HCC question for this tutorial using the Ask Questions button.</p>
  <p><a class="btn" href="https://community.hortonworks.com/topics/tutorial-570.html" role="button">Find Answers</a> <a class="btn pull-right" href="https://community.hortonworks.com/questions/ask.html?space=81&topics=tutorial-570&topics=hdp-2.5.0" role="button">Ask Questions</a></p>
  <p>Tutorial Name: <strong>Securing Data Lake Resources and Auditing User Access with Apache Ranger</strong></p>
  <p>HCC Tutorial Tag:<strong> tutorial-570</strong> and <strong>hdp-2.5.0</strong></p>
  <p>If the tutorial has multiple labs please indicate which lab your question corresponds to. Please provide any feedback related to that lab.</p>
  <p>All Hortonworks, partner and community tutorials are posted in the Hortonworks github and can be contributed via the <a href="https://github.com/hortonworks/tutorials/wiki">Hortonworks Tutorial Contribution Guide</a>.  If you are certain there is an issue or bug with the tutorial, please <a href="https://github.com/hortonworks/tutorials/wiki#issues-with-tutorials">create an issue</a> on the repository and we will do our best to resolve it!</p>
</div>
