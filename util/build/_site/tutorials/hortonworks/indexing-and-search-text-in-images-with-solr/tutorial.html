

<div class="tutorial-content">
  <p>A very common request from many customers is to be able to index text in image files; for example, text in scanned PNG files. In this tutorial we are going to walkthrough how to do this with SOLR.</p>

<h3 id="prerequisiteprerequisites"><a href="#prerequisite"></a>Prerequisites</h3>

<ul>
  <li>Download the <a href="http://hortonworks.com/sandbox">Hortonworks Sandbox</a></li>
  <li>Complete the <a href="http://hortonworks.com/hadoop-tutorial/learning-the-ropes-of-the-hortonworks-sandbox/">Learning the Ropes of the HDP Sandbox</a> tutorial.</li>
</ul>

<h3 id="step-by-step-guidestep-by-step-guide"><a href="#step-by-step-guide"></a>Step-by-step guide</h3>

<ul>
  <li><strong>Install dependencies – this will provide you support for processing pngs, jpegs, and tiffs</strong></li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>yum install autoconf automake libtool

yum install libpng-devel

yum install libjpeg-devel

yum install libtiff-devel

yum install zlib-devel
</code></pre>
</div>

<ul>
  <li><strong>Download Leptonica, an image processing library</strong></li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>wget http://www.leptonica.org/source/leptonica-1.69.tar.gz
</code></pre>
</div>

<ul>
  <li><strong>Download Tesseract, an Optical Character Recognition engine</strong></li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>wget http://tesseract-ocr.googlecode.com/files/tesseract-ocr-3.02.02.tar.gz
</code></pre>
</div>

<ul>
  <li><strong>Ensure proper variables and pathing are set</strong>– This is necessary so that when building leptonica, the build can find the dependencies that you installed earlier. If the path is not correct, you will get Unsupported image type errors when running tesseract command line client.</li>
</ul>

<p>Also, when installing tesseract, you will place language data at TESSDATA_PREFIX dir.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cat ~/.bashrc
export TESSDATA_PREFIX='/usr/local/share/'
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib:/usr/lib64
</code></pre>
</div>

<ul>
  <li><strong>Build Leptonica</strong></li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>tar xvf leptonica-1.69.tar.gz 
cd leptonica-1.69  
./configure
make
sudo make install
</code></pre>
</div>

<p>Change the working directory to ~.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd ~
</code></pre>
</div>

<ul>
  <li><strong>Build Tesseract</strong></li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>tar xvf tesseract-ocr-3.02.02.tar.gz
cd tesseract-ocr
./autogen.sh
./configure
make
sudo make install
sudo ldconfig
</code></pre>
</div>

<p>Change the working directory to ~.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd ~
</code></pre>
</div>

<ul>
  <li><strong>Download tesseract language(s) and place them in TESSDATA_PREFIX dir, defined above</strong></li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>wget http://tesseract-ocr.googlecode.com/files/tesseract-ocr-3.02.eng.tar.gz
tar xzf tesseract-ocr-3.02.eng.tar.gz
cp tesseract-ocr/tessdata/eng* /usr/local/share/tessdata
cp tesseract-ocr/tessdata/Make* /usr/local/share/tessdata
</code></pre>
</div>

<ul>
  <li><strong>Test Tesseract</strong> – Use the image in this blog post. You'll notice that this is where I started. The 'hard' part of this was getting the builds correct for leptonica. And the problem there was ensuring that I had the correct dependencies installed and that they were available on the path defined above. If this doesn't work, there's no sense moving on to SOLR.</li>
</ul>

<p><a href="http://blog.thedigitalgroup.com/vijaym/2015/07/17/using-solr-and-tikaocr-to-search-text-inside-an-image/">http://blog.thedigitalgroup.com/vijaym/2015/07/17/using-solr-and-tikaocr-to-search-text-inside-an-image/</a></p>

<p>Copy the file from your local machine to the sandbox using scp utility. Go to the location where the image got downloaded, then do:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>scp -P 2222 OM_1.jpg root@127.0.0.1:/root/
</code></pre>
</div>

<p>Coming back to the sandbox terminal, now do:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/usr/local/bin/tesseract ~/OM_1.jpg ~/OM_out
</code></pre>
</div>

<p><strong>Tesseract Open Source OCR Engine v3.02.02 with Leptonica</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>cat ~/OM_out.txt   

'  '"I" " "'  ./
lrast. Shortly before the classes started I was visiting a.
certain public school, a school set  in a typically English
countryside, which on the June clay of my visit was wonder-
fully beauliful.  The  Head  Master—-no less typical than his
school and the country-side—pointed out the charms of
both,  and his pride came out  in the ?nal remark which he made
beforehe left me.  He explained that he had a class to take
in'I'heocritus.  Then  (with a. buoyant gesture);  "  Can you
, conceive anything more delightful than a class  in  Theocritus,
on such a day and  in such a place?"`
</code></pre>
</div>

<p>If you have text in your out file, then you've done it correctly!</p>

<ol>
  <li><strong>Start Solr Sample – This sample contains the Proper Extracting Request Handler for processing with tika</strong></li>
</ol>

<p><a href="https://wiki.apache.org/solr/ExtractingRequestHandler">https://wiki.apache.org/solr/ExtractingRequestHandler</a></p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd  /opt/lucidworks-hdpsearch/solr/bin/  ./solr -e dih
</code></pre>
</div>

<ul>
  <li><strong>Use SOLR Admin to upload the image</strong></li>
</ul>

<p>Go back to the blog post or to the RequestHandler page for the proper update/extract command syntax.</p>

<ol>
  <li>From SOLR admin, select the tika core.</li>
  <li>Click Documents</li>
  <li>In the Request-Handler (qt) field, enter /update/extract</li>
  <li>In the Document Type drop down, select File Upload</li>
  <li>Choose the jpg file</li>
  <li>In the Extracting Req. Handler Params box, type the following:</li>
</ol>

<p><code class="highlighter-rouge">literal.id=d1&amp;uprefix=attr_&amp;fmap.content=attr_content&amp;commit=true</code></p>

<p>Understanding all the parameters is another process, but the <code class="highlighter-rouge">literal.id</code> is the unique id for the document. For more information on this command, start by reviewing <a href="https://wiki.apache.org/solr/ExtractingRequestHandler">https://wiki.apache.org/solr/ExtractingRequestHandler</a> and then the SOLR documentation.</p>

<ul>
  <li><strong>Run a query</strong>
    <ol>
      <li>From SOLR admin, select tika core.</li>
      <li>Click Query.</li>
      <li>In the q field, type attr_content:explained</li>
      <li>Execute the query.</li>
    </ol>
  </li>
</ul>

<p><a href="http://sandbox.hortonworks.com:8983/solr/tika/select?q=attr_content%3Aexplained&amp;wt=json&amp;indent=true">http://sandbox.hortonworks.com:8983/solr/tika/select?q=attr_content%3Aexplained&amp;wt=json&amp;indent=true</a></p>

<ul>
  <li><strong>Try it again</strong></li>
</ul>

<p>Use another png or supported file type. Be sure to use the same Request Handler Params, except provide a new unique <code class="highlighter-rouge">literal.id</code>. Note, that the attr_content is a dynamic field, and it cannot be highlighted.</p>

<p>I am sure this example can be extended to many use cases that we have not imagined. Let us know in the comments, if you are doing interesting things with Solr.</p>

</div>

<div id="tutorial-footer">
  <hr>
  <h2>Tutorial Q&amp;A and Reporting Issues</h2>
  <p>If you need help or have questions with this tutorial, please first check HCC for existing Answers to questions on this tutorial using the Find Answers button.  If you don't find your answer you can post a new HCC question for this tutorial using the Ask Questions button.</p>
  <p><a class="btn" href="https://community.hortonworks.com/topics/tutorial-510.html" role="button">Find Answers</a> <a class="btn pull-right" href="https://community.hortonworks.com/questions/ask.html?space=81&topics=tutorial-510&topics=hdp-2.4.0" role="button">Ask Questions</a></p>
  <p>Tutorial Name: <strong>Indexing and Searching Text within Images with Solr</strong></p>
  <p>HCC Tutorial Tag:<strong> tutorial-510</strong> and <strong>hdp-2.4.0</strong></p>
  <p>If the tutorial has multiple labs please indicate which lab your question corresponds to. Please provide any feedback related to that lab.</p>
  <p>All Hortonworks, partner and community tutorials are posted in the Hortonworks github and can be contributed via the <a href="https://github.com/hortonworks/tutorials/wiki">Hortonworks Tutorial Contribution Guide</a>.  If you are certain there is an issue or bug with the tutorial, please <a href="https://github.com/hortonworks/tutorials/wiki#issues-with-tutorials">create an issue</a> on the repository and we will do our best to resolve it!</p>
</div>
