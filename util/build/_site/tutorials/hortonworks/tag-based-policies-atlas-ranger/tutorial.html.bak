

<div class="tutorial-content">
  <h2 id="introduction">Introduction</h2>

<p>Hortonworks has recently announced the integration of Apache Atlas and Apache Ranger, and introduced the concept of tag or classification based policies. Enterprises can classify data in Apache Atlas and use the classification to build security policies in Apache Ranger.</p>

<p>This tutorial walks through an example of tagging data in Atlas and building a security policy in Ranger.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li><a href="http://hortonworks.com/downloads/#sandbox">Download Hortonworks 2.5 Sandbox</a></li>
  <li>Complete the <a href="http://hortonworks.com/hadoop-tutorial/learning-the-ropes-of-the-hortonworks-sandbox/">Learning the Ropes of the Hortonworks Sandbox tutorial,</a> you will need it for logging into Ambari.</li>
</ul>

<h2 id="outline">Outline</h2>

<ul>
  <li><a href="#start-services">1: Start Kafka, HBase, Ambari Infra, Ranger and Atlas</a>
    - <a href="#view-service-page">1.1: View the Services Page</a>
    - <a href="#start-kafka">1.2: Start Kafka Service</a></li>
  <li><a href="#general-information">2: General Information</a></li>
  <li><a href="#sample-ranger-policy">3: Sample Ranger Policy for Different User Personas</a></li>
  <li><a href="#access-without-tag">4: Access Without Tag Based Policies</a></li>
  <li><a href="#create-tag-based-policy">5: Create Tag and Tag Based Policy</a></li>
  <li><a href="#summary">6: Summary</a></li>
</ul>

<h2 id="1-start-kafka-hbase-ambari-infra-ranger-and-atlas-">1. Start Kafka, HBase, Ambari Infra, Ranger and Atlas <a id="start-services"></a></h2>

<h3 id="11-view-the-services-page-">1.1 View the Services Page <a id="view-service-page"></a></h3>

<p>Started by logging into Ambari as raj_ops user.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/ambari_dashboard_rajops.png" alt="ambari_dashboard_rajops" /></p>

<p>From the Dashboard page of Ambari, click on Kafka from the list of installed services.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/new_select_kafka.png" alt="new_select_kafka" /></p>

<h3 id="12-start-kafka-service-">1.2 Start Kafka Service <a id="start kafka"></a></h3>

<p>From the Kafka page, click on <code class="highlighter-rouge">Service Actions -&gt; Start</code></p>

<p><img src="/assets/tag-based-policies-atlas-ranger/start_kafka.png" alt="start_kafka" /></p>

<p>Check the box and click on <code class="highlighter-rouge">Confirm Start</code>:</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/confirmation_kafka.png" alt="confirmation_kafka" /></p>

<p>Wait for Kafka to start (It may take a few minutes to turn green)</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/new_started_kafka.png" alt="new_started_kafka" /></p>

<p>Now start other required services as well. Ranger Tagsync is stopped by default so please restart Ranger as well. Finally, start Atlas at the end. Your Ambari dashboard page should look like this:</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/new_ambari_dashboard.png" alt="new_ambari_dashboard" /></p>

<h2 id="2-general-information-">2. General Information <a id="general-information"></a></h2>

<p>Ranger can be accessed using the following credentials:</p>

<p>User id – <strong>raj_ops</strong><br />
Password – <strong>raj_ops</strong></p>

<p>And for Atlas:</p>

<p>User id – <strong>holger_gov</strong><br />
Password – <strong>holger_gov</strong></p>

<p>In the tutorial steps below, we are going to be using user ids raj_ops and maria_dev. You can login into Ambari view using the following credentials</p>

<p>User id – <strong>raj_ops</strong>   <br />
Password – <strong>raj_ops</strong></p>

<p>User id – <strong>maria_dev</strong><br />
Password – <strong>maria_dev</strong></p>

<h2 id="3-sample-ranger-policy-for-different-user-personas-">3. Sample Ranger Policy for Different User Personas <a id="sample-ranger-policy"></a></h2>

<p>Navigate to Ranger UI by typing <code class="highlighter-rouge">127.0.0.1:6080</code> on browser, you will see a Ranger login page:</p>

<p>Use username - raj_ops and password - raj_ops</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/ranger_login_rajops.png" alt="ranger_login_rajops" /></p>

<p>Press <code class="highlighter-rouge">Sign In</code> button, the home page of Ranger will be displayed. Click on <code class="highlighter-rouge">Sandbox_hive</code>.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/click_sandbox_hive_rajops.png" alt="click_sandbox_hive_rajops" /></p>

<p>You will now see a list of policies under Sandbox_hive repository. Click on the box of last policy which is <strong>policy for raj_ops, holger_gov, maria_dev and amy_ds</strong></p>

<p><img src="/assets/tag-based-policies-atlas-ranger/click_policy_for_all_users_rajops.png" alt="click_policy_for_all_users_rajops" /></p>

<p>This policy is meant for these 4 users and is applied to all tables and all columns of a <code class="highlighter-rouge">foodmart</code> database.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/sample_foodmart_policy_rajops.png" alt="sample_foodmart_policy_rajops" /></p>

<p>To check the type of access that this policy imposed on these users, scroll down:</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/allow_condition_sample_policy_rajops.png" alt="allow_condition_sample_policy_rajops" /></p>

<p>You can give any access to the users as per their roles in the organization.</p>

<h2 id="4-access-without-tag-based-policies-">4. Access Without Tag Based Policies <a id="access-without-tag"></a></h2>

<p>Let’s create a hive table employee from Ambari <code class="highlighter-rouge">Hive View</code>.</p>

<p>Go back to Ambari and then to Hive view from 9 square menu icon, and type the following create table query:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>create table employee (ssn string, name string, location string)
row format delimited
fields terminated by ','
stored as textfile;
</code></pre>
</div>

<p>And click on green <code class="highlighter-rouge">Execute</code> button.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/create_hive_table.png" alt="create_hive_table" /></p>

<p>You can check whether your table gets created or not by refreshing database explorer. Click on default database, you will see a new employee table.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/list_hive_table.png" alt="list_hive_table" /></p>

<p>Now let’s put some records into this table.</p>

<p>First SSH into the Hortonworks Sandbox with the command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ssh root@127.0.0.1 -p 2222
</code></pre>
</div>

<p><img src="/assets/tag-based-policies-atlas-ranger/sshTerminal.png" alt="sshTerminal" /></p>

<p>Create a new file called <code class="highlighter-rouge">employeedata.txt</code> from the terminal:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vi employeedata.txt
</code></pre>
</div>

<p>And put following data:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>111-111-111,James,San Jose
222-222-222,Mike,Santa Clara
333-333-333,Robert,Fremont
</code></pre>
</div>

<p>Exit the vi shell by typing Esc–&gt;wq!
Now copy this file to HDFS where employee table data is being stored.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>hadoop fs -copyFromLocal employeedata.txt /apps/hive/warehouse/employee
</code></pre>
</div>

<p>Now let’s go back to hive view to view this data.</p>

<p>Go to database explorer and press the button right next to employee table:</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/view_data.png" alt="view_data" /></p>

<p>You will be able to see the data.</p>

<p>In the first scenario, you have an <code class="highlighter-rouge">employee</code> data table in Apache Hive with <code class="highlighter-rouge">ssn, name and location</code> as part of the columns. The ssn and location information is deemed sensitive and users should not have access to it.</p>

<p>You need to create a Ranger policy which allows for access to name column except ssn and location. This policy will be assigned to both raj_ops and maria_dev user for now.</p>

<p>Go to Ranger UI on:
<code class="highlighter-rouge">127.0.0.1:6080</code></p>

<p><img src="/assets/tag-based-policies-atlas-ranger/ranger_homepage_rajops.png" alt="ranger_homepage_rajops" /></p>

<p>Go back to <code class="highlighter-rouge">Sandbox_hive</code> and then <code class="highlighter-rouge">Add New Policy</code>:</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/new_sandbox_hive_policies.png" alt="new_sandbox_hive_policies" /></p>

<p>Enter following values:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Policy Names - policy to restrict employee data
Hive Databases - default
table - employee
Hive_column - ssn, location (NOTE : Do NOT forget to exclude these columns)
Description - Any description
</code></pre>
</div>

<p>In the <code class="highlighter-rouge">Allow Conditions</code>, it should have the following values:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Select Group – blank, no input
Select User – raj_ops, maria_dev
Permissions – Click on the + sign next to Add Permissions and click on select and then green tick mark.
</code></pre>
</div>

<p><img src="/assets/tag-based-policies-atlas-ranger/add_permission.png" alt="add_permission" /></p>

<p>You should have your policy configured like this:</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/employee_policy_rajops.png" alt="employee_policy_rajops" /></p>

<p>Click on <code class="highlighter-rouge">Add</code> and you can see the list of policies that are present in <code class="highlighter-rouge">Sandbox_hive</code>.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/employee_policy_added_rajops.png" alt="employee_policy_added_rajops" /></p>

<p>You have to disable the <code class="highlighter-rouge">Hive Global Tables Allow</code> to test out the one that you just created. Go inside to this policy and toggle to disable it.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/hive_global_policy_rajops.png" alt="hive_global_policy_rajops" /></p>

<p>To check the access, get back to Ambari as <code class="highlighter-rouge">maria_dev</code> user.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/maria_dev_ambari_login.png" alt="maria_dev_ambari_login" /></p>

<p>Go directly to <code class="highlighter-rouge">Hive View</code>, click on default database and employee table. Press the button to view the table data.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/maria_dev_access_error.png" alt="maria_dev_access_error" /></p>

<p>You will get an authorization error. This is expected as the user does not have access to 2 columns in this table (ssn and location). To verify this, you can also view the Audits in Ranger. Go back to Ranger and click on <code class="highlighter-rouge">Audits=&gt;Access</code> and select <code class="highlighter-rouge">Sandbox_hive</code> in Service Name. You will see the entry of Access Denied for maria_dev.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/new_policy_audit.png" alt="new_policy_audit" /></p>

<p>Now coming back to Hive View, try running a query for selective column.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>SELECT name from employee LIMIT 100;
</code></pre>
</div>

<p><img src="/assets/tag-based-policies-atlas-ranger/maria_dev_access_successful.png" alt="maria_dev_access_successful" /></p>

<p>The query runs successfully.
Even, <strong>raj_ops</strong> user cannot not see all the columns the location and SSN. We would provide access to this user to all columns later.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/restrict_policy_rajops.png" alt="restrict_policy_rajops" /></p>

<h2 id="5-create-tag-and-tag-based-policy-">5. Create Tag and Tag Based Policy <a id="create-tag-based-policy"></a></h2>

<p>As a first step, login into ATLAS web app using <code class="highlighter-rouge">http://127.0.0.1:21000/</code> and use username <strong>holger_gov</strong> and password <strong>holger_gov</strong>.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/new_atlas_login.png" alt="new_atlas_login" /></p>

<p>Go to <code class="highlighter-rouge">Tags</code> tab and press <code class="highlighter-rouge">Create Tag</code> button.
Give it a name as <strong>PII</strong> and description as <strong>Personal Identifiable Information</strong>.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/new_create_tag.png" alt="new_create_tag" /></p>

<p>Now go to <code class="highlighter-rouge">Search</code> tab and write <code class="highlighter-rouge">employee</code> in the box. It will give all the entities related to word employee.
Click on employee</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/search_employee_rajops.png" alt="search_employee_rajops" /></p>

<p>You can view the details of an employee hive table.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/view_employee_hive_table.png" alt="view_employee_hive_table" /></p>

<p>Go to <code class="highlighter-rouge">Schema</code> tab to assign specific columns to PII tag.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/employee_schema_rajops.png" alt="employee_schema_rajops" /></p>

<p>Press blue + button to assign the tag to <code class="highlighter-rouge">SSN</code>. Then, Select <code class="highlighter-rouge">PII</code> from the list of tags and click Save.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/add_tags_rajops.png" alt="add_tags_rajops" /></p>

<p>Repeat the same for the <code class="highlighter-rouge">location</code> row from the above list. Refresh the page, now you should see both ssn and location columns are marked with <code class="highlighter-rouge">PII</code> tag. What essentially it means that we have classified any data in the ssn and location columns as PII.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/pii_tag_assigned_rajops.png" alt="pii_tag_assigned_rajops" /></p>

<p>Now let’s go back to Ranger UI. The tag and entity relationship will be automatically inherited by Ranger. In Ranger, we can create a tag based policy by accessing it from the top menu. Go to <code class="highlighter-rouge">Access Manager → Tag Based Policies</code>.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/select_tag_based_policies_rajops.png" alt="select_tag_based_policies_rajops" /></p>

<p>You will see a page like given below.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/new_tag_rajops.png" alt="new_tag_rajops" /></p>

<p>Click <code class="highlighter-rouge">+</code> button to create a new tag service.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/add_sandbox_tag_rajops.png" alt="add_sandbox_tag_rajops" /></p>

<p>Give it a name <code class="highlighter-rouge">Sandbox_tag</code> and click <code class="highlighter-rouge">Add</code>.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/added_sandbox_tag_rajops.png" alt="added_sandbox_tag_rajops" /></p>

<p>Click on <code class="highlighter-rouge">Sandbox_tag</code> to add a policy.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/add_new_policy_rajops.png" alt="add_new_policy_rajops" /></p>

<p>Click on <code class="highlighter-rouge">Add New Policy</code> button.
Give following details:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Policy Name – PII column access policy
Tag – PII
Description – Any description
Audit logging – Yes
</code></pre>
</div>

<p><img src="/assets/tag-based-policies-atlas-ranger/pii_column_access_policy_rajops.png" alt="pii_column_access_policy_rajops" /></p>

<p>In the Allow Conditions, it should have the following values:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Select Group - blank
Select User - raj_ops
Component Permissions - Select Hive
</code></pre>
</div>

<p>You can select the component permission through this popup:</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/new_allow_permissions.png" alt="new_allow_permissions" /></p>

<p>Please verify that Allow Conditions section is looking like this:</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/allow_conditions_rajops.png" alt="allow_conditions_rajops" /></p>

<p>This signifies that only raj_ops is allowed to do any operation on the columns that are specified by PII tag. Click <code class="highlighter-rouge">Add</code>.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/pii_policy_created_rajops.png" alt="pii_policy_created_rajops" /></p>

<p>Now click on <code class="highlighter-rouge">Resource Based Policies</code> and edit <code class="highlighter-rouge">Sandbox_hive</code> repository by clicking on the button next to it.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/editing_sandbox_hive.png" alt="editing_sandbox_hive" /></p>

<p>Click on <code class="highlighter-rouge">Select Tag Service</code> and select <code class="highlighter-rouge">Sandbox_tag</code>. Click on <code class="highlighter-rouge">Save</code>.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/new_edited_sandbox_hive.png" alt="new_edited_sandbox_hive" /></p>

<p>The Ranger tag based policy is now enabled for <strong>raj_ops</strong> user. You can test it by running the query on all columns in employee table.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/admin_access_successful.png" alt="admin_access_successful" /></p>

<p>The query executes successfully. The query can be checked in the Ranger audit log which will show the access granted and associated policy which granted access. Select Service Name as <code class="highlighter-rouge">Sandbox_hive</code> in the search bar.</p>

<p><img src="/assets/tag-based-policies-atlas-ranger/audit_results_rajops.png" alt="audit_results_rajops" /></p>

<blockquote>
  <p><strong>NOTE</strong>: There are 2 policies which provided access to raj_ops user, one is a tag based policy and the other is hive resource based policy. The associated tags (PII) is also denoted in the tags column in the audit record).</p>
</blockquote>

<h2 id="6-summary-">6. Summary <a id="summary"></a></h2>

<p>Ranger traditionally provided group or user based authorization for resources such as table, column in Hive or a file in HDFS.
With the new Atlas -Ranger integration, administrators can conceptualize security policies based on data classification, and not necessarily in terms of tables or columns. Data stewards can easily classify data in Atlas and use in the classification in Ranger to create security policies.
This represents a paradigm shift in security and governance in Hadoop, benefiting customers with mature Hadoop deployments as well as customers looking to adopt Hadoop and big data infrastructure for first time.</p>

</div>

<div id="tutorial-footer">
  <hr>
  <h2>Tutorial Q&amp;A and Reporting Issues</h2>
  <p>If you need help or have questions with this tutorial, please first check HCC for existing Answers to questions on this tutorial using the Find Answers button.  If you don't find your answer you can post a new HCC question for this tutorial using the Ask Questions button.</p>
  <p><a class="btn" href="https://community.hortonworks.com/topics/tutorial-660.html" role="button">Find Answers</a> <a class="btn pull-right" href="https://community.hortonworks.com/questions/ask.html?space=81&topics=tutorial-660&topics=hdp-2.5.0" role="button">Ask Questions</a></p>
  <p>Tutorial Name: <strong>Tag Based Policies with Apache Ranger and Apache Atlas</strong></p>
  <p>HCC Tutorial Tag:<strong> tutorial-660</strong> and <strong>hdp-2.5.0</strong></p>
  <p>If the tutorial has multiple labs please indicate which lab your question corresponds to. Please provide any feedback related to that lab.</p>
  <p>All Hortonworks, partner and community tutorials are posted in the Hortonworks github and can be contributed via the <a href="https://github.com/hortonworks/tutorials/wiki">Hortonworks Tutorial Contribution Guide</a>.  If you are certain there is an issue or bug with the tutorial, please <a href="https://github.com/hortonworks/tutorials/wiki#issues-with-tutorials">create an issue</a> on the repository and we will do our best to resolve it!</p>
</div>
