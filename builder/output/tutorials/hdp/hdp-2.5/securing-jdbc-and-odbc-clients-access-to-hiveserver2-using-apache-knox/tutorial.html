<div class="tutorial-content">
  <h1 id="securing-jdbc-and-odbc-clients-access-to-hiveserver2-using-apache-knox">Securing JDBC and ODBC Clients’ Access to HiveServer2 using Apache Knox</h1>

<h2 id="introduction">Introduction</h2>

<p><a href="#https://hortonworks.com/products/data-center/hdp/">HDP 2.5</a> ships with Apache Knox 0.6.0. This release of Apache Knox supports WebHDFS, WebHCAT, Oozie, Hive, and HBase REST APIs.</p>

<p>Apache Hive is a popular component used for SQL access to Hadoop, and the Hive Server 2 with Thrift supports JDBC access over HTTP. The following steps show the configuration to enable a JDBC client to talk to Hive Server 2 via Knox <strong>(Beeline &gt; JDBC over HTTPS &gt; Knox &gt; HTTP &gt; Hive Server2)</strong>. The picture describes the scenario that the tutorial covers.</p>

<p><img src="https://raw.githubusercontent.com/orendain/big-data-tutorials/master/tutorials/hdp/hdp-2.5/securing-jdbc-and-odbc-clients-access-to-hiveserver2-using-apache-knox/assets/knox_access.png" alt="knox_access" /></p>

<p>This tutorial focuses on Beeline as the JDBC client; however, a screenshot of Simba ODBC Client configuration for ODBC access is attached at the bottom of the tutorial.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li><a href="https://hortonworks.com/downloads/#sandbox">Download Hortonworks 2.5 Sandbox</a>.</li>
  <li>Complete the <a href="https://hortonworks.com/hadoop-tutorial/learning-the-ropes-of-the-hortonworks-sandbox/">Learning the Ropes of the Hortonworks Sandbox tutorial,</a> you will need it for logging into Ambari.</li>
</ul>

<h2 id="outline">Outline</h2>

<ul>
  <li><a href="#start-knox">1. Start Knox</a></li>
  <li><a href="#change-hive-config">2. Change Hive Config</a></li>
  <li><a href="#run-beeline">3. Run Beeline Client</a></li>
  <li><a href="#connect-hive">4. Connect to Hive Server 2</a></li>
  <li><a href="#issue-query">5. Issue the Query</a></li>
  <li><a href="#simba-odbc">6. Simba ODBC Client Configuration</a></li>
  <li><a href="#summary">Summary</a></li>
</ul>

<h2 id="1-start-knox-">1. Start Knox <a id="start-knox"></a></h2>

<p>Open up the Ambari user interface by using the URL http://sandbox.hortonworks.com:8080.
Using Virtualbox it might look like http://127.0.0.1:8080. If you’re using Azure make sure to replace 127.0.0.1 with you host machine’s IP address.</p>

<p>Login to Ambari using the following:
Username - <strong>raj_ops</strong>
Password - <strong>raj_ops</strong></p>

<p>After logging in to Ambari, you will see a list of Services.</p>

<p><img src="https://raw.githubusercontent.com/orendain/big-data-tutorials/master/tutorials/hdp/hdp-2.5/securing-jdbc-and-odbc-clients-access-to-hiveserver2-using-apache-knox/assets/ambari_dashboard_rajops.png" alt="ambari_dashboard_rajops" /></p>

<p>Now Select <code class="highlighter-rouge">Knox</code> from the list of Services on the left-hand side of the page.
Then click on <code class="highlighter-rouge">Service Actions</code> from the top right hand side of the page click on <code class="highlighter-rouge">Start</code>.</p>

<p><img src="https://raw.githubusercontent.com/orendain/big-data-tutorials/master/tutorials/hdp/hdp-2.5/securing-jdbc-and-odbc-clients-access-to-hiveserver2-using-apache-knox/assets/start_knox.png" alt="start_knox" /></p>

<p>Check the box for <code class="highlighter-rouge">Maintenance Mode</code> and click <code class="highlighter-rouge">Confirm Start</code>.</p>

<p><img src="https://raw.githubusercontent.com/orendain/big-data-tutorials/master/tutorials/hdp/hdp-2.5/securing-jdbc-and-odbc-clients-access-to-hiveserver2-using-apache-knox/assets/knox_maintenance_mode.png" alt="knox_maintenance_mode" /></p>

<h2 id="2-change-hive-config-">2. Change Hive Config <a id="change-hive-config"></a></h2>

<p>Using Ambari, navigate to <code class="highlighter-rouge">Hive &gt; Config</code>. Type <code class="highlighter-rouge">hive.server2.transport.mode</code> in the Filter box. Change its value from <code class="highlighter-rouge">binary</code> to <code class="highlighter-rouge">http</code>.</p>

<p><img src="https://raw.githubusercontent.com/orendain/big-data-tutorials/master/tutorials/hdp/hdp-2.5/securing-jdbc-and-odbc-clients-access-to-hiveserver2-using-apache-knox/assets/change_hive_settings.png" alt="change_hive_settings" /></p>

<p>Save these Hive settings and restart Hive with Ambari.</p>

<h2 id="3-run-beeline-client-">3. Run Beeline Client <a id="run-beeline"></a></h2>

<p>First you’re going to need to login to your Sandbox via SSH.
If you’re using Virtualbox you can log in with the command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ssh root@127.0.0.1 -p 2222
</code></pre>
</div>

<p>The first time password to log in is: <strong>hadoop</strong></p>

<p><img src="https://raw.githubusercontent.com/orendain/big-data-tutorials/master/tutorials/hdp/hdp-2.5/securing-jdbc-and-odbc-clients-access-to-hiveserver2-using-apache-knox/assets/sshTerminal.png" alt="sshTerminal" /></p>

<p>In the example here, I am connecting to Knox on <a href="https://hortonworks.com/products/sandbox/">HDP 2.5 Sandbox</a> which uses a self-signed certificate for SSL. Use the connection string specified to enter into beeline shell.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>beeline
</code></pre>
</div>

<h2 id="4-connect-to-hive-server-2-">4. Connect to Hive Server 2 <a id="connect-hive"></a></h2>

<p>Type the following command in the beeline shell:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>!connect jdbc:hive2://sandbox.hortonworks.com:8443/foodmart;ssl=true;sslTrustStore=/var/lib/knox/data-2.5.0.0-1245/security/keystores/gateway.jks;trustStorePassword=knox?hive.server2.transport.mode=http;hive.server2.thrift.http.path=gateway/default/hive
</code></pre>
</div>

<p>Enter username and password that Beeline will send to Knox over HTTPS to authenticate the user. The Knox included with HDP 2.5 Sandbox has the account with the username <strong>guest</strong> and the password <strong>guest-password</strong>. Knox also supports using LDAP/AD for authentication, and once you configure Knox against LDAP, you can use any LDAP user to authenticate instead of guest account used in this example.</p>

<p>Enter username for:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>jdbc:hive2://sandbox.hortonworks.com:8443/foodmart;ssl=true;sslTrustStore=/var/lib/knox/data-2.5.0.0-1245/security/keystores/gateway.jks;trustStorePassword=knox?hive.server2.transport.mode=http;hive.server2.thrift.http.path=gateway/default/hive: guest
</code></pre>
</div>

<p>Enter password for:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>jdbc:hive2://sandbox.hortonworks.com:8443/foodmart;ssl=true;sslTrustStore=/var/lib/knox/data-2.5.0.0-1245/security/keystores/gateway.jks;trustStorePassword=knox?hive.server2.transport.mode=http;hive.server2.thrift.http.path=gateway/default/hive: **************
</code></pre>
</div>

<p>You should see a message like this:</p>

<p><code class="highlighter-rouge">Connected to: Apache Hive (version 1.2.1000.2.5.0.0-1245)</code></p>

<p><img src="https://raw.githubusercontent.com/orendain/big-data-tutorials/master/tutorials/hdp/hdp-2.5/securing-jdbc-and-odbc-clients-access-to-hiveserver2-using-apache-knox/assets/beeline_shell.png" alt="beeline_shell" /></p>

<p>In the Beeline connection string, a trust store for HTTPS connection to Knox is specified. This truststore (and its password) is needed only when Knox is not configured to use a well-known SSL certificate. For example, in an out-of-band access, Knox Gateway uses a Self-Signed certificate for SSL, and that certificate needs to be exported and put into a file that the client can use.
However, in a production environment, Knox should be configured to use a CA authorized SSL certificate, and on the JDBC client, you need not configure a truststore and truststore password.</p>

<h2 id="5-issue-the-query-">5. Issue the Query <a id="issue-query"></a></h2>

<p>Then issue any SQL query, and the request will follow the path from <strong>Beeline &gt; JDBC over HTTPS to Knox &gt; over HTTP to Hive Server 2</strong></p>

<p>For example, the show tables query results in the following output in HDP 2.5 Sandbox:</p>

<p><img src="https://raw.githubusercontent.com/orendain/big-data-tutorials/master/tutorials/hdp/hdp-2.5/securing-jdbc-and-odbc-clients-access-to-hiveserver2-using-apache-knox/assets/show_tables.png" alt="show_tables" /></p>

<p>If you get an error something like this :</p>

<p>Error: org.apache.thrift.transport.TTransportException: org.apache.http.NoHttpResponseException: sandbox.hortonworks.com:8443 failed to respond (state=08S01,code=0)</p>

<p>Go back to Ambari and <strong>Restart Knox</strong>.</p>

<h2 id="6-simba-odbc-client-configuration-">6. Simba ODBC Client Configuration <a id="simba-odbc"></a></h2>

<p>The following screenshot illustrates the ODBC client side configuration needed to get <strong>Simba ODBC &gt; HTTP &gt; Knox &gt; HTTP &gt; Hive Server 2</strong> setup working.</p>

<p><img src="https://raw.githubusercontent.com/orendain/big-data-tutorials/master/tutorials/hdp/hdp-2.5/securing-jdbc-and-odbc-clients-access-to-hiveserver2-using-apache-knox/assets/simba_odbc_access.png" alt="simba_odbc_access" /></p>

<h2 id="summary-">Summary <a id="summary"></a></h2>

<p><a href="https://hortonworks.com/apache/knox-gateway/">Apache Knox</a> provides the ability to secure Hadoop’s REST API centrally. With Apache Knox, the REST/HTTP access to Hadoop benefits from centralized authentication, authorization, audit, identity management integration and SSO. In this blog we covered the configuration and steps needed for JDBC &amp; ODBC clients to connect via Knox to Hive Server 2.</p>

</div>

<hr>

<div id="tutorial-footer">
  <h2>Tutorial Q&amp;A and Reporting Issues</h2>

  <p>If you need help or have questions with this tutorial, please check HCC for answers to existing questions about this tutorial by using the Find Answers button below.  You can post a new HCC question by using the Ask Questions button below.</p>

  <p>
    <a class="btn" href="https://community.hortonworks.com/topics/tutorial-560.html" role="button">Find Answers</a>
    <a class="btn pull-right" href="https://community.hortonworks.com/questions/ask.html?space=81&topics=tutorial-560&amp;topics=hdp-2.5.0" role="button">Ask Questions</a>
  </p>

  <p>Tutorial Name: <strong>Securing JDBC and ODBC Clients' Access to HiveServer2 using Apache Knox</strong></p>
  <p>HCC Tags:<strong> tutorial-560</strong> and <strong>hdp-2.5.0</strong></p>
  <p>If the tutorial has multiple components please indicate which one your question relates to.</p>

  <p>All Hortonworks, partner and community tutorials are posted in the Hortonworks GitHub repository and can be contributed to by following the <a href="https://github.com/hortonworks/big-data-tutorials/wiki">Tutorial Contribution Guide</a>.  For issues/bugs/feedback, please <a href="https://github.com/hortonworks/big-data-tutorials/issues/new">submit an issue</a> and we will do our best to resolve it!</p>
</div>

