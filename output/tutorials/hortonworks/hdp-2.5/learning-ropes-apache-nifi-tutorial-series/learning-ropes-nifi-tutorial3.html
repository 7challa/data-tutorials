<div class="tutorial-content">
  <h1 id="tutorial-3-ingest-nextbus-live-stream-routes-to-the-dataflow">Tutorial 3: Ingest NextBus Live Stream Routes to the DataFlow</h1>

<h2 id="introduction">Introduction</h2>
<p>In this tutorial, you will replace the section of our dataflow that generates the simulation of vehicle location XML data with a new section that ingests a live stream of data from NextBus San Francisco Muni Agency on route OceanView into our NiFi DataFlow.</p>

<p>In this tutorial, you will build the Ingest NextBus SF Muni Live Stream section of the dataflow:</p>

<p><img src="assets/lab3-ingest-nextbus-live-stream-nifi-lab-series/complete_dataflow_lab3_live_stream_ingestion.png" alt="complete_dataflow_lab3_live_stream_ingestion" /></p>

<p>Feel free to download the <a href="https://raw.githubusercontent.com/hortonworks/tutorials/hdp/assets/learning-ropes-nifi-lab-series/lab3-template/Lab3-NiFi-Learn-Ropes.xml">Lab3-NiFi-Learn-Ropes.xml</a> template file or if you prefer to build the dataflow from scratch, continue on to the lab.</p>

<h2 id="pre-requisites">Pre-Requisites</h2>
<ul>
  <li>Completed Tutorial 0: Download, Install and Start NiFi</li>
  <li>Completed Tutorial 1: Build A Simple NiFi DataFlow</li>
  <li>Completed Tutorial 2: Enhance the DataFlow with Geo Location Enrichment</li>
</ul>

<h2 id="outline">Outline</h2>
<ul>
  <li><a href="#nextbus-live-feed">NextBus Live Feed</a></li>
  <li><a href="#attach-nextbus-live-stream">Step 1: Attach NextBus Live Stream to the DataFlow</a></li>
  <li><a href="#run-nifi-dataflow">Step 2: Run the NiFi DataFlow</a></li>
  <li><a href="#summary-tutorial3">Summary</a></li>
  <li><a href="#further-reading-tutorial3">Further Reading</a></li>
</ul>

<h2 id="nextbus-live-feed-">NextBus Live Feed <a id="nextbus-live-feed"></a></h2>

<p>NextBus Live Feed provides the public with live information regarding passenger information, such as vehicle location information, prediction times on transit vehicles, routes of vehicles and different agencies (San Francisco Muni, Unitrans City of Davis, etc). We will learn to use NextBus’s API to access the XML Live Feed Data and create an URL. In this URL we will specify parameters in a query string. The parameters for the tutorial will include the vehicle location, agency, route and time.</p>

<p>After viewing the Live Feed Documentation, we created the following URL for the GetHTTP processor:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>http://webservices.nextbus.com/service/publicXMLFeed?command=vehicleLocations&amp;a=sf-muni&amp;r=M&amp;t=0
</code></pre>
</div>

<p>Let’s break apart the parameters, so we can better understand how to create custom URLs. There are 4 parameters:</p>

<ul>
  <li>commands: command = vehicleLocations</li>
  <li>agency: a=sf-muni</li>
  <li>route: r=M</li>
  <li>time: t=0</li>
</ul>

<p>Refer to <a href="https://www.nextbus.com/xmlFeedDocs/NextBusXMLFeed.pdf">NextBus’s Live Feed Documentation</a> to learn more about each parameter.</p>

<h3 id="step-1-attach-nextbus-live-stream-to-the-dataflow-">Step 1: Attach NextBus Live Stream to the DataFlow <a id="attach-nextbus-live-stream"></a></h3>

<h3 id="gethttp">GetHTTP</h3>

<p>1. Delete GetFile, UnpackContent and ControlRate processors. We will replace them with the GetHTTP processor.</p>

<p>2. Add the <strong>GetHTTP</strong> processor and drag it to the place where the previous three processors were located. Connect GetHTTP to EvaluateXPath processor located above SplitXML. When the Create Connection window appears, select <strong>success</strong> checkbox. Click <strong>Add</strong>.</p>

<p>3. Open GetHTTP Config Property Tab window. We will need to copy and paste Nextbus XML Live Feed URL into the property value. Add the property listed in <strong>Table 1</strong>.</p>

<p><strong>Table 1:</strong> Update GetHTTP Properties Tab</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Property</th>
      <th style="text-align: right">Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">URL</code></td>
      <td style="text-align: right"><code class="highlighter-rouge">http://webservices.nextbus.com/service/publicXMLFeed?command=vehicleLocations&amp;a=sf-muni&amp;r=M&amp;t=0</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">Filename</code></td>
      <td style="text-align: right"><code class="highlighter-rouge">vehicleLoc_SF_OceanView_${now():format("HHmmssSSS")}.xml</code></td>
    </tr>
  </tbody>
</table>

<p><img src="assets/lab3-ingest-nextbus-live-stream-nifi-lab-series/getHTTP_liveStream_config_property_tab_window.png" alt="getHTTP_liveStream_config_property_tab_window" /></p>

<p>4. Now that each property is updated. Navigate to the <strong>Scheduling tab</strong> and change the <strong>Run Schedule</strong> from 0 sec to <code class="highlighter-rouge">4 sec</code>, so that the processor executes a task every 1 second. Therefore, overuse of system resources is prevented.</p>

<p>5. Open the processor config <strong>Settings</strong> tab, change the processor’s Name from GetHTTP to <code class="highlighter-rouge">NextBusXMLFeed</code>. Click <strong>Apply</strong> button.</p>

<h3 id="modify-putfile-in-geo-enrich-section">Modify PutFile in Geo Enrich Section</h3>

<p>1. Open PutFile Configure <strong>Properties Tab</strong>. Change the Directory property value from the previous value to the value shown in <strong>Table 2</strong>:</p>

<p><strong>Table 2:</strong> Update PutFile Properties Tab</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Property</th>
      <th style="text-align: right">Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">Directory</code></td>
      <td style="text-align: right"><code class="highlighter-rouge">/tmp/nifi/output/nearby_neighborhoods_liveStream</code></td>
    </tr>
  </tbody>
</table>

<p><strong>Directory</strong> is changed to a new location for the real-time data coming in from NextBus live stream.</p>

<p><img src="assets/lab3-ingest-nextbus-live-stream-nifi-lab-series/modify_putFile_in_geo_enrich_section.png" alt="modify_putFile_in_geo_enrich_section" /></p>

<p>2. Click <strong>Apply</strong>.</p>

<h3 id="step-2-run-the-nifi-dataflow-">Step 2: Run the NiFi DataFlow <a id="run-nifi-dataflow"></a></h3>

<p>Now that we added NextBus San Francisco Muni Live Stream Ingestion to our dataflow , let’s run the dataflow and verify if we receive the expected results in our output directory.</p>

<p>1. Go to the actions toolbar and click the start button <img src="assets/lab1-build-nifi-dataflow/start_button_nifi_iot.png" alt="start_button_nifi_iot" />. Your screen should look like the following:</p>

<p><img src="assets/lab3-ingest-nextbus-live-stream-nifi-lab-series/complete_dataflow_lab3_live_stream_ingestion.png" alt="complete_dataflow_lab3_live_stream_ingestion" /></p>

<p>2. Let’s verify the data in output directory is correct. Navigate to the following directories and open a random one to check the data.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd /tmp/nifi/output/nearby_neighborhoods_liveStream
ls
vi 002a7d47-b6bb-41e1-b930-0e172a54638b
</code></pre>
</div>

<p>Did you receive neighborhoods similar to the image below?</p>

<p><img src="assets/lab3-ingest-nextbus-live-stream-nifi-lab-series/nextbus_liveStream_output_lab3.png" alt="nextbus_liveStream_output_lab3" /></p>

<h2 id="summary-">Summary <a id="summary-tutorial3"></a></h2>

<p>Congratulations! You learned how to use NextBus’s API to connect to their XML Live Feed for vehicle location data. You also learned how to use the GetHTTP processor to ingest a live stream from NextBus San Francisco Muni into NiFi!</p>

<h2 id="further-reading-">Further Reading <a id="further-reading-tutorial3"></a></h2>

<ul>
  <li><a href="https://www.nextbus.com/xmlFeedDocs/NextBusXMLFeed.pdf">NextBus XML Live Feed</a></li>
  <li><a href="https://docs.hortonworks.com/HDPDocuments/HDF2/HDF-2.0.0/bk_user-guide/content/index.html">Hortonworks NiFi User Guide</a></li>
  <li><a href="https://docs.hortonworks.com/HDPDocuments/HDF2/HDF-2.0.0/bk_developer-guide/content/index.html">Hortonworks NiFi Developer Guide</a></li>
</ul>

</div>

<div id="tutorial-footer">
  <hr>
  <h2>Tutorial Q&amp;A and Reporting Issues</h2>
  <p>If you need help or have questions with this tutorial, please first check HCC for existing Answers to questions on this tutorial using the Find Answers button.  If you don't find your answer you can post a new HCC question for this tutorial using the Ask Questions button.</p>
  <p><a class="btn" href="https://community.hortonworks.com/topics/tutorial-/tutorials/hortonworks/hdp-2.5/learning-ropes-apache-nifi-tutorial-series/learning-ropes-nifi-tutorial3.html" role="button">Find Answers</a> <a class="btn pull-right" href="https://community.hortonworks.com/questions/ask.html?space=81&topics=tutorial-hdf-2.0.0&topics=hdf-2.0.0" role="button">Ask Questions</a></p>
  <p>Tutorial Name: <strong>Tutorial 3 Ingest NextBus Live Stream Routes to the DataFlow</strong></p>
  <p>HCC Tutorial Tag:<strong> tutorial-/tutorials/hortonworks/hdp-2.5/learning-ropes-apache-nifi-tutorial-series/learning-ropes-nifi-tutorial3</strong> and <strong>hdf-2.0.0</strong></p>
  <p>If the tutorial has multiple labs please indicate which lab your question corresponds to. Please provide any feedback related to that lab.</p>
  <p>All Hortonworks, partner and community tutorials are posted in the Hortonworks github and can be contributed via the <a href="https://github.com/hortonworks/tutorials/wiki">Hortonworks Tutorial Contribution Guide</a>.  If you are certain there is an issue or bug with the tutorial, please <a href="https://github.com/hortonworks/tutorials/wiki#issues-with-tutorials">create an issue</a> on the repository and we will do our best to resolve it!</p>
</div>

